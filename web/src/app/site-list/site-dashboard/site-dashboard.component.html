<div class="dashboard-container">
  <!-- 頂部統計卡片區 -->
  <div class="dashboard-header">
    <!-- 日期卡片 -->
    <div class="info-card">
      <h3 class="card-title">今日日期</h3>
      <div class="card-content">
        <div class="large-value">{{ todayDate }}</div>
      </div>
    </div>

    <!-- 工程進度卡片 -->
    <div class="info-card">
      <h3 class="card-title">工程進度</h3>
      <div class="card-content">
        <div class="progress-banner">
          <div class="progress-icon">
            <i class="fas fa-chart-bar"></i>
          </div>
          <div class="progress-details">
            <div class="progress-value">{{ currentProjectProgress }}%</div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width]="currentProjectProgress + '%'"
              ></div>
            </div>
          </div>
        </div>

        <!-- 工程日數資訊 -->
        <div class="timeline-info">
          <div class="stat-card">
            <div class="stat-value">{{ allProjectDays }}</div>
            <div class="stat-label">總工程日數</div>
          </div>
          <div class="timeline-separator">
            <div class="timeline-line"></div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ todayProjectDays }}</div>
            <div class="stat-label">已過日數</div>
            <div class="stat-subtitle">
              {{ ((todayProjectDays / allProjectDays) * 100).toFixed(1) }}%
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 天氣資訊卡 -->
    <div
      class="info-card"
      (click)="navigateTo('weather')"
      [class.clickable]="true"
      title="點擊後查看今日天氣詳細資訊"
    >
      <h3 class="card-title">
        今日天氣({{ site?.county }})
        <span class="info-icon-right"
          ><i
            class="fas fa-info-circle"
            title="顯示目前工地所在區域的天氣資訊"
          ></i
        ></span>
      </h3>
      <div class="card-content weather-content">
        <div class="weather-icon">
          <i class="fas fa-cloud-sun"></i>
        </div>
        <div class="weather-value">{{ todayWeather }}</div>
      </div>
    </div>
  </div>

  <!-- 其他統計資訊 -->
  <div class="stats-grid">
    <div class="info-card">
      <h3 class="card-title">
        工安零事故時數
        <!-- <span class="info-icon-right"
          ><i class="fas fa-info-circle" title="顯示距離最後一次事故的連續安全時數"></i
        ></span> -->
      </h3>
      <div class="card-content stat-content">
        <div class="stat-tile-icon">
          <i class="fas fa-shield-alt text-success"></i>
        </div>
        <div class="large-value text-success">{{ zeroAccidentHours }}</div>
        <div class="stat-subtitle">連續安全小時</div>
        @if (lastAccidentDate) {
          <small class="text-muted">自 {{ lastAccidentDate | date : "yyyy/MM/dd HH:mm" }} 以來</small>
        } @else {
          <small class="text-success">專案開始以來零事故</small>
        }
      </div>
    </div>

    <div
      class="info-card"
      (click)="navigateTo('permit')"
      [class.clickable]="true"
      title="點擊後查看許可單統計詳細資訊"
    >
      <h3 class="card-title">
        許可單統計
        <span class="info-icon-right"
          ><i class="fas fa-info-circle" title="顯示今日許可單數量統計"></i
        ></span>
      </h3>
      <div class="card-content">
        <!-- 總數顯示 -->
        <div class="stat-content mb-3">
          <div class="stat-tile-icon">
            <i class="fas fa-file-circle-check"></i>
          </div>
          <div class="large-value">{{ todayPermitCount }}</div>
          <div class="stat-subtitle">今日許可單數</div>
        </div>
        
        <!-- 作業類別統計 -->
        @if (permitCategoryStats.length > 0) {
          <div class="category-stats">
            <div class="category-stats-header">
              <small class="text-muted">
                <i class="fas fa-chart-pie me-1"></i>作業類別分佈
              </small>
            </div>
            <div class="category-stats-list">
              @for (stat of permitCategoryStats.slice(0, 5); track stat.category) {
                <div class="category-item">
                  <div class="category-info">
                    <i [class]="stat.icon" [style.color]="stat.color"></i>
                    <span class="category-name">{{ stat.displayName }}</span>
                  </div>
                  <span class="category-count badge" [style.background-color]="stat.color">
                    {{ stat.count }}
                  </span>
                </div>
              }
              @if (permitCategoryStats.length > 5) {
                <div class="category-item text-muted">
                  <span class="category-name">
                    <i class="fas fa-ellipsis-h me-1"></i>
                    還有 {{ permitCategoryStats.length - 5 }} 種作業類別
                  </span>
                </div>
              }
            </div>
          </div>
        } @else if (todayPermitCount === 0) {
          <div class="text-center text-muted mt-2">
            <small>今日無許可單作業</small>
          </div>
        } @else if (todayPermitCount > 0 && permitCategoryStats.length === 0) {
          <div class="text-center text-muted mt-2">
            <small>許可單無作業類別資料</small>
          </div>
        }
      </div>
    </div>

    <div class="info-card">
      <h3 class="card-title">人員統計</h3>
      <div class="card-content">
        <!-- 總數顯示 -->
        <div class="stat-content mb-3">
          <div class="stat-tile-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="large-value">{{ todayWorkerCount }}</div>
          <div class="stat-subtitle">今日工地人數</div>
        </div>
        
        <!-- 廠商統計 -->
        @if (contractorWorkerStats.length > 0) {
          <div class="contractor-stats">
            <div class="contractor-stats-header">
              <small class="text-muted">
                <i class="fas fa-building me-1"></i>廠商人數分佈
              </small>
            </div>
            <div class="contractor-stats-list">
              @for (stat of contractorWorkerStats.slice(0, 5); track stat.contractorName) {
                <div class="contractor-item">
                  <div class="contractor-info">
                    <i [class]="stat.icon" [style.color]="stat.color"></i>
                    <span class="contractor-name" [title]="stat.contractorName">{{ stat.contractorName }}</span>
                  </div>
                  <div class="contractor-count-info">
                    <span class="contractor-count badge" [style.background-color]="stat.color">
                      {{ stat.workerCount }}
                    </span>
                    <small class="contractor-percentage text-muted">{{ stat.percentage }}%</small>
                  </div>
                </div>
              }
              @if (contractorWorkerStats.length > 5) {
                <div class="contractor-item text-muted">
                  <span class="contractor-name">
                    <i class="fas fa-ellipsis-h me-1"></i>
                    還有 {{ contractorWorkerStats.length - 5 }} 個廠商
                  </span>
                </div>
              }
            </div>
          </div>
        } @else if (todayWorkerCount === 0) {
          <div class="text-center text-muted mt-2">
            <small>今日無工人出工記錄</small>
          </div>
        }
      </div>
    </div>

    <div
      class="info-card"
      (click)="navigateTo('flaw')"
      [class.clickable]="true"
      title="點擊後查看缺失統計詳細資訊"
    >
      <h3 class="card-title">
        缺失統計
        <span class="info-icon-right"
          ><i class="fas fa-info-circle" title="顯示今日缺失單數量統計"></i
        ></span>
      </h3>
      <div class="card-content stat-content">
        <div class="stat-tile-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="large-value">{{ todayFlawCount }}</div>
        <div class="stat-subtitle">今日缺失單數</div>
      </div>
    </div>
  </div>

  <!-- 圖表區域 -->
  <div class="charts-container">
    <div class="info-card">
      <h3 class="card-title">工程進度趨勢</h3>
      <div class="card-content">
        <app-progress-trend-chart [siteId]="siteId"></app-progress-trend-chart>
      </div>
    </div>

    <div class="info-card">
      <h3 class="card-title">缺失趨勢</h3>
      <div class="card-content chart-wrapper">
        <canvas #chartFlaw id="chartFlaw"></canvas>
      </div>
    </div>
  </div>
</div>
