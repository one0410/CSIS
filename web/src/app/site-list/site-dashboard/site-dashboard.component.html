<main class="dashboard-container">
  <!-- 頂部時間顯示 -->
  <header class="dashboard-time-header">
    <time class="current-datetime">{{ currentDateTime }}</time>
  </header>

  <!-- 第一區塊：即時資訊 -->
  <section class="dashboard-section" aria-label="即時資訊">
    <!-- 環境監測指標 -->
    <article class="info-card environment-card" (click)="navigateTo('weather')" [class.clickable]="true" role="button" tabindex="0">
      <h2 class="card-title">環境監測指標</h2>
      <div class="card-content">
        <!-- 環境指標 -->
        <div class="environment-grid">
          <!-- 溫度 -->
          <div class="env-item">
            <div class="env-icon temperature">
              <i class="fas fa-thermometer-half" aria-hidden="true"></i>
            </div>
            <div class="env-value">{{ environmentData.temperature }}°C</div>
            <div class="env-label">溫度</div>
          </div>
          <!-- 濕度 -->
          <div class="env-item">
            <div class="env-icon humidity">
              <i class="fas fa-tint" aria-hidden="true"></i>
            </div>
            <div class="env-value">{{ environmentData.humidity }}%</div>
            <div class="env-label">濕度</div>
          </div>
          <!-- 風速 -->
          <div class="env-item">
            <div class="env-icon wind">
              <i class="fas fa-wind" aria-hidden="true"></i>
            </div>
            <div class="env-value">{{ environmentData.windSpeed }}km/h</div>
            <div class="env-label">風速</div>
          </div>
          <!-- 風向 -->
          <div class="env-item">
            <div class="env-icon wind-direction">
              <i class="fas fa-compass" aria-hidden="true"></i>
            </div>
            <div class="env-value">{{ environmentData.windDirection }}</div>
            <div class="env-label">風向</div>
          </div>
          <!-- PM10 -->
          <div class="env-item">
            <div class="env-icon pm10" [class.warning]="environmentData.pm10 > 50" [class.danger]="environmentData.pm10 > 100">
              <i class="fas fa-cloud" aria-hidden="true"></i>
            </div>
            <div class="env-value">{{ environmentData.pm10 }}</div>
            <div class="env-label">PM10 μg/m³</div>
          </div>
          <!-- PM2.5 -->
          <div class="env-item">
            <div class="env-icon pm25" [class.warning]="environmentData.pm25 > 35" [class.danger]="environmentData.pm25 > 75">
              <i class="fas fa-smog" aria-hidden="true"></i>
            </div>
            <div class="env-value">{{ environmentData.pm25 }}</div>
            <div class="env-label">PM2.5 μg/m³</div>
          </div>
        </div>
        <!-- 熱危害指數儀表 -->
        <div class="heat-index-section">
          <h3 class="section-subtitle">熱危害指數</h3>
          <app-heat-index-gauge
            [temperature]="environmentData.temperature"
            [humidity]="environmentData.humidity">
          </app-heat-index-gauge>
        </div>
      </div>
      <div class="expand-icon" aria-hidden="true">
        <i class="fas fa-external-link-alt"></i>
      </div>
    </article>

    <!-- 今日實時出工狀況 -->
    <article class="info-card worker-status-card">
      <h2 class="card-title">{{ todayDateShort }}(今日)實時出工狀況</h2>
      <div class="card-content">
        <!-- 彙總區域 -->
        <div class="worker-summary">
          <div class="summary-row">
            <i class="fas fa-users summary-icon supplier-icon" aria-hidden="true"></i>
            <span class="summary-label">供應商在案人數</span>
            <span class="summary-count">{{ supplierWorkerCount }}人</span>
          </div>
          <div class="summary-row">
            <i class="fas fa-building summary-icon main-contractor-icon" aria-hidden="true"></i>
            <span class="summary-label">帆宣員工在案人數</span>
            <span class="summary-count">{{ mainContractorWorkerCount }}人</span>
          </div>
        </div>
        <!-- 供應商詳細列表 -->
        <div class="worker-status-list">
          @for (stat of supplierContractorStats; track stat.contractorName) {
            <div class="worker-row">
              <div class="worker-icon">
                <i class="fas fa-hard-hat" [style.color]="stat.color" aria-hidden="true"></i>
              </div>
              <span class="contractor-label">{{ stat.contractorName }}</span>
              <span class="worker-count-badge" [style.background-color]="stat.color">{{ stat.workerCount }}人</span>
            </div>
          }
          @if (contractorWorkerStats.length === 0) {
            <div class="no-data">今日無工人出工記錄</div>
          }
        </div>
        <div class="total-workers">
          <span>總計：</span>
          <strong>{{ todayWorkerCount }}人</strong>
        </div>
      </div>
    </article>

    <!-- 許可單統計 -->
    <article class="info-card permit-card" (click)="navigateTo('permit')" [class.clickable]="true" role="button" tabindex="0">
      <h2 class="card-title">許可單統計</h2>
      <div class="card-content">
        <div class="permit-header">
          <div class="permit-total">
            <span class="permit-label">今日有效許可單</span>
            <span class="permit-count">{{ todayPermitCount }}張</span>
          </div>
        </div>
        <ul class="permit-category-list">
          <!-- 一般作業 -->
          <li class="permit-item">
            <i class="fas fa-clipboard-check" style="color: #0d6efd;" aria-hidden="true"></i>
            <span class="permit-name">一般作業</span>
            <span class="permit-badge" style="background-color: #0d6efd;">{{ generalWorkCount }}項</span>
          </li>
          <!-- 特殊作業 -->
          <li class="permit-item permit-group-header">
            <i class="fas fa-exclamation-triangle" style="color: #dc3545;" aria-hidden="true"></i>
            <span class="permit-name">特殊作業</span>
            <span class="permit-badge" style="background-color: #dc3545;">{{ specialWorkTotalCount }}項</span>
          </li>
          <!-- 特殊作業子項目 -->
          @for (stat of specialWorkStats; track stat.category) {
            <li class="permit-item permit-sub-item">
              <i [class]="stat.icon" [style.color]="stat.color" aria-hidden="true"></i>
              <span class="permit-name">{{ stat.displayName }}</span>
              <span class="permit-badge" [style.background-color]="stat.color">{{ stat.count }}項</span>
            </li>
          }
          @if (generalWorkCount === 0 && specialWorkStats.length === 0 && todayPermitCount === 0) {
            <li class="no-data">今日無許可單作業</li>
          }
        </ul>
      </div>
      <div class="expand-icon" aria-hidden="true">
        <i class="fas fa-external-link-alt"></i>
      </div>
    </article>
  </section>

  <!-- 第二區塊：今日統計圖表 -->
  <section class="dashboard-section" aria-label="今日統計">
    <!-- 今日各承攬商違規次數統計 -->
    <article class="info-card">
      <h2 class="card-title">今日各承攬商違規次數統計</h2>
      <div class="card-content chart-content">
        <app-today-contractor-violation-chart [siteId]="siteId"></app-today-contractor-violation-chart>
      </div>
    </article>

    <!-- 今日違規種類統計 -->
    <article class="info-card">
      <h2 class="card-title">今日違規種類統計</h2>
      <div class="card-content chart-content">
        <app-today-violation-type-chart [siteId]="siteId"></app-today-violation-type-chart>
      </div>
    </article>

    <!-- 明日預計出工狀況（來源：工地許可單） -->
    <article class="info-card tomorrow-worker-card">
      <h2 class="card-title">{{ tomorrowDateShort }}(明日)預計出工狀況</h2>
      <div class="card-content">
        <!-- 承攬商詳細列表 -->
        <div class="worker-status-list">
          @for (stat of tomorrowWorkerStats; track stat.contractorName) {
            <div class="worker-row">
              <div class="worker-icon">
                <i class="fas fa-hard-hat" [style.color]="stat.color" aria-hidden="true"></i>
              </div>
              <span class="contractor-label">{{ stat.contractorName }}</span>
              <span class="worker-count-badge" [style.background-color]="stat.color">{{ stat.workerCount }}人</span>
            </div>
          }
          @if (tomorrowWorkerStats.length === 0) {
            <div class="no-data">明日無預計出工記錄</div>
          }
        </div>
        <div class="total-workers">
          <span>預計總計：</span>
          <strong>{{ tomorrowTotalWorkers }}人</strong>
        </div>
      </div>
    </article>
  </section>

  <!-- 第三區塊：月報表統計 -->
  <section class="dashboard-section" aria-label="月報表統計">
    <!-- 每月累積出工人數 -->
    <article class="info-card">
      <h2 class="card-title">每月累積出工人數</h2>
      <div class="card-content chart-content">
        <app-monthly-worker-chart [siteId]="siteId"></app-monthly-worker-chart>
      </div>
    </article>

    <!-- 當月各供應商累積出工人數 -->
    <article class="info-card">
      <h2 class="card-title">當月各供應商累積出工人數</h2>
      <div class="card-content chart-content">
        <app-contractor-worker-chart [siteId]="siteId"></app-contractor-worker-chart>
      </div>
    </article>

    <!-- 工安零事故時數 -->
    <app-zero-accident-hours></app-zero-accident-hours>
  </section>

  <!-- 第四區塊：違規與進度統計 -->
  <section class="dashboard-section" aria-label="違規與進度統計">
    <!-- 當月各供應商違規次數統計 -->
    <article class="info-card">
      <h2 class="card-title">當月各供應商違規次數統計</h2>
      <div class="card-content chart-content">
        <app-contractor-violation-chart [siteId]="siteId"></app-contractor-violation-chart>
      </div>
    </article>

    <!-- 當月違規種類統計 -->
    <article class="info-card">
      <h2 class="card-title">當月違規種類統計</h2>
      <div class="card-content chart-content">
        <app-violation-type-chart [siteId]="siteId"></app-violation-type-chart>
      </div>
    </article>

    <!-- 工程進度 -->
    <article class="info-card progress-card">
      <h2 class="card-title">工程進度</h2>
      <div class="card-content">
        <div class="progress-summary">
          <div class="progress-main">
            <div class="progress-percentage">{{ currentProjectProgress }}%</div>
            <div class="progress-bar-large">
              <div class="progress-fill" [style.width.%]="currentProjectProgress"></div>
            </div>
          </div>
          <div class="progress-dates">
            <div class="date-info">
              <span class="date-label">自</span>
              <span class="date-value">{{ site?.startDate | date:'yyyy年M月d日' }}</span>
            </div>
            <div class="date-info">
              <span class="date-label">至</span>
              <span class="date-value">{{ site?.endDate | date:'yyyy年M月d日' }}</span>
            </div>
          </div>
        </div>
        <div class="progress-trend">
          <app-progress-trend-chart [siteId]="siteId"></app-progress-trend-chart>
        </div>
      </div>
    </article>
  </section>
</main>
