<main class="dashboard-container">
  <!-- 頂部統計卡片區 -->
  <header class="dashboard-header">
    <!-- 日期卡片 -->
    <article class="info-card">
      <h2 class="card-title">今日日期</h2>
      <div class="card-content">
        <p class="large-value">{{ todayDate }}</p>
        <p class="large-value">{{ todayWeekday }}</p>
      </div>
    </article>

    <!-- 工程進度卡片 -->
    <article class="info-card">
      <h2 class="card-title">工程進度</h2>
      <div class="card-content">
        <figure class="progress-banner">
          <div class="progress-icon">
            <i class="fas fa-chart-bar" aria-hidden="true"></i>
          </div>
          <figcaption class="progress-details">
            <data class="progress-value" [value]="currentProjectProgress">{{ currentProjectProgress }}%</data>
            <div class="progress-bar" role="progressbar" [attr.aria-valuenow]="currentProjectProgress" aria-valuemin="0" aria-valuemax="100" aria-label="工程進度">
              <div class="progress-fill" [style.width]="currentProjectProgress + '%'"></div>
            </div>
          </figcaption>
        </figure>

        <!-- 工程日數資訊 -->
        <dl class="timeline-info">
          <div class="stat-card">
            <dd class="stat-value">{{ allProjectDays }}</dd>
            <dt class="stat-label">總工程日數</dt>
          </div>
          <div class="timeline-separator">
            <div class="timeline-line"></div>
          </div>
          <div class="stat-card">
            <dd class="stat-value">{{ todayProjectDays }}</dd>
            <dt class="stat-label">已過日數</dt>
            <dd class="stat-subtitle">
              {{ ((todayProjectDays / allProjectDays) * 100).toFixed(1) }}%
            </dd>
          </div>
        </dl>
      </div>
    </article>

    <!-- 天氣資訊卡 -->
    <article class="info-card" (click)="navigateTo('weather')" [class.clickable]="true" title="點擊後查看今日天氣詳細資訊" role="button" tabindex="0">
      <h2 class="card-title">
        今日天氣({{ site?.county }})
        <span class="info-icon-right"><i class="fas fa-info-circle" title="顯示目前工地所在區域的天氣資訊" aria-hidden="true"></i></span>
      </h2>
      <div class="card-content weather-content">
        <div class="weather-icon">
          <i class="fas fa-cloud-sun" aria-hidden="true"></i>
        </div>
        <data class="weather-value">{{ todayWeather }}</data>
      </div>
      <!-- 展開圖示 -->
      <div class="expand-icon" aria-hidden="true">
        <i class="fas fa-external-link-alt"></i>
      </div>
    </article>
  </header>

  <!-- 其他統計資訊 -->
  <section class="stats-grid" aria-label="統計資訊">
    <app-zero-accident-hours>
    </app-zero-accident-hours>

    <article class="info-card" (click)="navigateTo('permit')" [class.clickable]="true" title="點擊後查看許可單統計詳細資訊" role="button" tabindex="0">
      <h2 class="card-title">
        許可單統計
        <span class="info-icon-right"><i class="fas fa-info-circle" title="顯示今日許可單數量統計" aria-hidden="true"></i></span>
      </h2>
      <div class="card-content">
        <!-- 總數顯示 -->
        <div class="stat-content mb-3">
          <div class="stat-tile-icon">
            <i class="fas fa-file-circle-check" aria-hidden="true"></i>
          </div>
          <data class="large-value" [value]="todayPermitCount">{{ todayPermitCount }}</data>
          <p class="stat-subtitle">今日許可單數</p>
        </div>

        <!-- 作業類別統計 -->
        @if (permitCategoryStats.length > 0) {
        <aside class="category-stats">
          <header class="category-stats-header">
            <small class="text-muted">
              <i class="fas fa-chart-pie me-1" aria-hidden="true"></i>作業類別分佈
            </small>
          </header>
          <ul class="category-stats-list">
            @for (stat of permitCategoryStats.slice(0, 5); track stat.category) {
            <li class="category-item">
              <span class="category-info">
                <i [class]="stat.icon" [style.color]="stat.color" aria-hidden="true"></i>
                <span class="category-name">{{ stat.displayName }}</span>
              </span>
              <data class="category-count badge" [style.background-color]="stat.color" [value]="stat.count">
                {{ stat.count }}
              </data>
            </li>
            }
            @if (permitCategoryStats.length > 5) {
            <li class="category-item text-muted">
              <span class="category-name">
                <i class="fas fa-ellipsis-h me-1" aria-hidden="true"></i>
                還有 {{ permitCategoryStats.length - 5 }} 種作業類別
              </span>
            </li>
            }
          </ul>
        </aside>
        } @else if (todayPermitCount === 0) {
        <p class="text-center text-muted mt-2">
          <small>今日無許可單作業</small>
        </p>
        } @else if (todayPermitCount > 0 && permitCategoryStats.length === 0) {
        <p class="text-center text-muted mt-2">
          <small>許可單無作業類別資料</small>
        </p>
        }
      </div>
      <!-- 展開圖示 -->
      <div class="expand-icon" aria-hidden="true">
        <i class="fas fa-external-link-alt"></i>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">人員統計</h2>
      <div class="card-content">
        <!-- 總數顯示 -->
        <div class="stat-content mb-3">
          <div class="stat-tile-icon">
            <i class="fas fa-users" aria-hidden="true"></i>
          </div>
          <data class="large-value" [value]="todayWorkerCount">{{ todayWorkerCount }}</data>
          <p class="stat-subtitle">今日工地人數</p>
        </div>

        <!-- 廠商統計 -->
        @if (contractorWorkerStats.length > 0) {
        <aside class="contractor-stats">
          <header class="contractor-stats-header">
            <small class="text-muted">
              <i class="fas fa-building me-1" aria-hidden="true"></i>廠商人數分佈
            </small>
          </header>
          <ul class="contractor-stats-list">
            @for (stat of contractorWorkerStats.slice(0, 5); track stat.contractorName) {
            <li class="contractor-item">
              <span class="contractor-info">
                <i [class]="stat.icon" [style.color]="stat.color" aria-hidden="true"></i>
                <span class="contractor-name" [title]="stat.contractorName">{{ stat.contractorName }}</span>
              </span>
              <span class="contractor-count-info">
                <data class="contractor-count badge" [style.background-color]="stat.color" [value]="stat.workerCount">
                  {{ stat.workerCount }}
                </data>
                <small class="contractor-percentage text-muted">{{ stat.percentage }}%</small>
              </span>
            </li>
            }
            @if (contractorWorkerStats.length > 5) {
            <li class="contractor-item text-muted">
              <span class="contractor-name">
                <i class="fas fa-ellipsis-h me-1" aria-hidden="true"></i>
                還有 {{ contractorWorkerStats.length - 5 }} 個廠商
              </span>
            </li>
            }
          </ul>
        </aside>
        } @else if (todayWorkerCount === 0) {
        <p class="text-center text-muted mt-2">
          <small>今日無工人出工記錄</small>
        </p>
        }
      </div>
    </article>

    <article class="info-card" (click)="navigateTo('flaw')" [class.clickable]="true" title="點擊後查看缺失統計詳細資訊" role="button" tabindex="0">
      <h2 class="card-title">
        缺失統計
        <span class="info-icon-right"><i class="fas fa-info-circle" title="顯示今日缺失單數量統計" aria-hidden="true"></i></span>
      </h2>
      <div class="card-content stat-content">
        <div class="stat-tile-icon">
          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
        </div>
        <data class="large-value" [value]="todayFlawCount">{{ todayFlawCount }}</data>
        <p class="stat-subtitle">今日缺失單數</p>
      </div>
      <!-- 展開圖示 -->
      <div class="expand-icon" aria-hidden="true">
        <i class="fas fa-external-link-alt"></i>
      </div>
    </article>
  </section>

  <!-- 圖表區域 -->
  <section class="charts-container" aria-label="統計圖表">
    <!-- 新增的四個圖表卡片 -->
    <article class="info-card">
      <h2 class="card-title">每月累積出工人數</h2>
      <div class="card-content">
        <app-monthly-worker-chart [siteId]="siteId"></app-monthly-worker-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">當月各供應商累積出工人數</h2>
      <div class="card-content">
        <app-contractor-worker-chart [siteId]="siteId"></app-contractor-worker-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">今日各供應商違規次數統計</h2>
      <div class="card-content">
        <app-today-contractor-violation-chart [siteId]="siteId"></app-today-contractor-violation-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">當月各供應商違規次數統計</h2>
      <div class="card-content">
        <app-contractor-violation-chart [siteId]="siteId"></app-contractor-violation-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">今日違規種類統計</h2>
      <div class="card-content">
        <app-today-violation-type-chart [siteId]="siteId"></app-today-violation-type-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">當月違規種類統計</h2>
      <div class="card-content">
        <app-violation-type-chart [siteId]="siteId"></app-violation-type-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">工程進度趨勢</h2>
      <div class="card-content">
        <app-progress-trend-chart [siteId]="siteId"></app-progress-trend-chart>
      </div>
    </article>

    <article class="info-card">
      <h2 class="card-title">缺失趨勢</h2>
      <div class="card-content">
        <app-flaw-trend-chart [siteId]="siteId"></app-flaw-trend-chart>
      </div>
    </article>

  </section>
</main>
