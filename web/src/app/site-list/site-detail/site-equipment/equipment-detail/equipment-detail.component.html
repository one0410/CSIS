<div class="container-fluid">
  <div class="d-flex align-items-center mb-4">
    <button class="btn btn-outline-secondary me-3" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> 返回
    </button>
    <h2 class="mb-0">
      @if (isNewEquipment()) {
        新增設備
      } @else {
        設備詳情
      }
    </h2>
  </div>

  @if (isLoading()) {
    <div class="d-flex justify-content-center my-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">讀取中...</span>
      </div>
    </div>
  } @else if (!equipment() && !isNewEquipment()) {
    <div class="alert alert-danger">
      找不到設備資訊，請返回設備列表。
    </div>
  } @else {
    <div class="row">
      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">基本資訊</h5>
            @if (!isEditing()) {
              <button class="btn btn-primary btn-sm" (click)="startEditing()">
                編輯
              </button>
            } @else {
              <div>
                <button type="button" class="btn btn-secondary btn-sm me-2" (click)="cancelEditing()">
                  @if (isNewEquipment()) { 取消 } @else { 取消 }
                </button>
                <button type="button" class="btn btn-primary btn-sm" (click)="saveEquipment()">
                  @if (isNewEquipment()) { 新增 } @else { 儲存 }
                </button>
              </div>
            }
          </div>
          <div class="card-body">
            <form>
              <div class="row mb-3">
                <label for="company" class="col-sm-3 col-form-label">承攬公司</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="company" 
                      [(ngModel)]="editedEquipment!.company" 
                      name="company"
                    >
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      [ngModel]="equipment()!.company" 
                      name="company" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="name" class="col-sm-3 col-form-label">設備名稱</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="name" 
                      [(ngModel)]="editedEquipment!.name" 
                      name="name" 
                      required
                    >
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      [ngModel]="equipment()!.name" 
                      name="name" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="model" class="col-sm-3 col-form-label">型號</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="model" 
                      [(ngModel)]="editedEquipment!.model" 
                      name="model"
                    >
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      [ngModel]="equipment()!.model" 
                      name="model" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="serialNumber" class="col-sm-3 col-form-label">序號</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="serialNumber" 
                      [(ngModel)]="editedEquipment!.serialNumber" 
                      name="serialNumber"
                    >
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      [ngModel]="equipment()!.serialNumber" 
                      name="serialNumber" 
                      readonly
                    >
                  }
                </div>
              </div>
              
              <div class="row mb-3">
                <label for="purchaseDate" class="col-sm-3 col-form-label">購買日期</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="date" 
                      class="form-control" 
                      id="purchaseDate" 
                      [(ngModel)]="editedEquipment!.purchaseDate" 
                      name="purchaseDate"
                    >
                  } @else {
                    <input 
                      type="date" 
                      class="form-control" 
                      [ngModel]="equipment()!.purchaseDate" 
                      name="purchaseDate" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="maintenanceDate" class="col-sm-3 col-form-label">最近維護日期</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="date" 
                      class="form-control" 
                      id="maintenanceDate" 
                      [(ngModel)]="editedEquipment!.maintenanceDate" 
                      name="maintenanceDate"
                    >
                  } @else {
                    <input 
                      type="date" 
                      class="form-control" 
                      [ngModel]="equipment()!.maintenanceDate" 
                      name="maintenanceDate" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="inspectionDate" class="col-sm-3 col-form-label">檢查日期</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="date" 
                      class="form-control" 
                      id="inspectionDate" 
                      [(ngModel)]="editedEquipment!.inspectionDate" 
                      name="inspectionDate"
                      (change)="onInspectionDateChange()"
                    >
                  } @else {
                    <input 
                      type="date" 
                      class="form-control" 
                      [ngModel]="equipment()!.inspectionDate" 
                      name="inspectionDate" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="nextInspectionType" class="col-sm-3 col-form-label">下次檢查類型</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <select 
                      class="form-select" 
                      id="nextInspectionType" 
                      [(ngModel)]="editedEquipment!.nextInspectionType" 
                      name="nextInspectionType"
                      (change)="onNextInspectionTypeChange()"
                    >
                      <option [ngValue]="undefined">請選擇</option>
                      <option value="weekly">每週</option>
                      <option value="monthly">每月</option>
                      <option value="quarterly">每季</option>
                      <option value="biannual">每半年</option>
                      <option value="yearly">每年</option>
                      <option value="custom">自定義日期</option>
                    </select>
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="nextInspectionType" 
                      [ngModel]="getNextInspectionTypeText(equipment()!.nextInspectionType)" 
                      name="nextInspectionType"
                      readonly
                    >
                  }
                </div>
              </div>
              @if (isEditing() && editedEquipment!.nextInspectionType === 'custom') {
                <div class="row mb-3">
                  <label for="nextInspectionDate" class="col-sm-3 col-form-label">下次檢查日期</label>
                  <div class="col-sm-9">
                    <input 
                      type="date" 
                      class="form-control" 
                      id="nextInspectionDate" 
                      [(ngModel)]="editedEquipment!.nextInspectionDate" 
                      name="nextInspectionDate"
                    >
                  </div>
                </div>
              } @else if (!isEditing() && equipment()!.nextInspectionDate) {
                <div class="row mb-3">
                  <label for="nextInspectionDate" class="col-sm-3 col-form-label">下次檢查日期</label>
                  <div class="col-sm-9">
                    <input 
                      type="date" 
                      class="form-control" 
                      id="nextInspectionDate" 
                      [ngModel]="equipment()!.nextInspectionDate" 
                      name="nextInspectionDate"
                      readonly
                    >
                  </div>
                </div>
              }
              <div class="row mb-3">
                <label for="isQualified" class="col-sm-3 col-form-label">合格狀態</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <select 
                      class="form-select" 
                      id="isQualified" 
                      [(ngModel)]="editedEquipment!.isQualified" 
                      name="isQualified"
                    >
                      <option [ngValue]="true">合格</option>
                      <option [ngValue]="false">不合格</option>
                    </select>
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="isQualified" 
                      [ngModel]="equipment()!.isQualified === undefined ? '未檢查' : (equipment()!.isQualified ? '合格' : '不合格')" 
                      name="isQualified"
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="status" class="col-sm-3 col-form-label">狀態</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <select 
                      class="form-select" 
                      id="status" 
                      [(ngModel)]="editedEquipment!.status" 
                      name="status"
                    >
                      <option value="available">可用</option>
                      <option value="inUse">使用中</option>
                      <option value="maintenance">維修中</option>
                      <option value="retired">已報廢</option>
                    </select>
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="status" 
                      [ngModel]="equipment()!.status === 'available' ? '可用' : 
                                equipment()!.status === 'inUse' ? '使用中' : 
                                equipment()!.status === 'maintenance' ? '維修中' : '已報廢'" 
                      name="status"
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="location" class="col-sm-3 col-form-label">位置</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <input 
                      type="text" 
                      class="form-control" 
                      id="location" 
                      [(ngModel)]="editedEquipment!.location" 
                      name="location"
                    >
                  } @else {
                    <input 
                      type="text" 
                      class="form-control" 
                      [ngModel]="equipment()!.location" 
                      name="location" 
                      readonly
                    >
                  }
                </div>
              </div>
              <div class="row mb-3">
                <label for="description" class="col-sm-3 col-form-label">描述</label>
                <div class="col-sm-9">
                  @if (isEditing()) {
                    <textarea 
                      class="form-control" 
                      id="description" 
                      [(ngModel)]="editedEquipment!.description" 
                      name="description"
                      rows="3"
                    ></textarea>
                  } @else {
                    <textarea 
                      class="form-control" 
                      id="description" 
                      [ngModel]="equipment()!.description" 
                      name="description"
                      rows="3"
                      readonly
                    ></textarea>
                  }
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">設備照片</h5>
          </div>
          <div class="card-body">
            @if (isNewEquipment()) {
            <div class="alert alert-info">
              請先儲存設備基本資訊後，再上傳照片。
            </div>
            } @else {
            <form class="mb-4" (ngSubmit)="uploadPhotos()">
              <div class="mb-3">
                <label for="photo-upload" class="form-label">上傳新照片（可選擇多張）</label>
                <input 
                  type="file" 
                  class="form-control" 
                  id="photo-upload" 
                  accept="image/*" 
                  multiple
                  (change)="onFilesSelected($event)"
                >
                <div class="form-text">可同時選擇多張照片進行上傳</div>
              </div>
              <div class="mb-3">
                <label for="caption" class="form-label">照片說明（套用到所有照片）</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="caption" 
                  [(ngModel)]="photoCaption" 
                  name="caption"
                  placeholder="為所有照片添加統一說明"
                >
              </div>
              
              @if (selectedFiles.length > 0) {
                <div class="mb-3">
                  <label class="form-label">已選擇的照片 ({{ selectedFiles.length }} 張)</label>
                  <div class="row row-cols-2 row-cols-md-3 g-2">
                    @for (file of selectedFiles; track file.name; let i = $index) {
                      <div class="col">
                        <div class="card">
                          <div class="card-body p-2">
                            <div class="d-flex align-items-center">
                              <i class="fas fa-image text-muted me-2 flex-shrink-0"></i>
                              <div class="flex-grow-1 min-width-0 overflow-hidden">
                                <small class="text-truncate d-block w-100" [title]="file.name" style="max-width: 100%;">{{ file.name }}</small>
                                <small class="text-muted d-block">{{ formatFileSize(file.size) }}</small>
                              </div>
                              <button 
                                type="button" 
                                class="btn btn-sm btn-outline-danger ms-2 flex-shrink-0" 
                                (click)="removeSelectedFile(i)"
                              >
                                <i class="fas fa-times"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
              
              <div class="d-flex justify-content-between align-items-center">
                <button 
                  type="button" 
                  class="btn btn-outline-secondary" 
                  (click)="clearSelectedFiles()"
                  [disabled]="selectedFiles.length === 0 || isUploading()"
                >
                  清除選擇
                </button>
                <button 
                  type="submit" 
                  class="btn btn-primary" 
                  [disabled]="selectedFiles.length === 0 || isUploading()"
                >
                  @if (isUploading()) {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    上傳中... ({{ uploadProgress.current }}/{{ uploadProgress.total }})
                  } @else {
                    上傳 {{ selectedFiles.length }} 張照片
                  }
                </button>
              </div>
            </form>

            @if (equipment()!.photos) {
              <div class="row row-cols-1 row-cols-md-2 g-4">
                @for (photo of equipment()!.photos ?? []; track photo.filename; let i = $index) {
                  <div class="col">
                    <div class="card h-100">
                      <img 
                        [src]="getPhotoUrl(photo.filename)" 
                        class="card-img-top equipment-photo" 
                        alt="設備照片"
                      >
                      <div class="card-body">
                        <p class="card-text">{{ photo.caption || '無說明' }}</p>
                        <p class="card-text"><small class="text-muted">
                          上傳於: {{ photo.uploadDate | date:'yyyy-MM-dd HH:mm' }}
                        </small></p>
                      </div>
                      <div class="card-footer d-flex justify-content-end">
                        <button 
                          class="btn btn-sm btn-danger" 
                          (click)="deletePhoto(i)"
                        >
                          刪除
                        </button>
                      </div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="alert alert-info">
                目前沒有設備照片，請上傳新照片。
              </div>
            }
            }
          </div>
        </div>
      </div>
    </div>
  }
</div> 