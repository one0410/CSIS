<div class="container-fluid bg-light min-vh-100 p-3">
  <div class="card form-card shadow-sm">
    <div class="card-body p-4">
      <!-- å¯¦éš›è¡¨å–®å…§å®¹å®¹å™¨ -->
      <div class="print-content">
        <!-- è¡¨å–®é ­éƒ¨ -->
        <app-site-form-header title="å·¥å®‰ç¼ºå¤±ç´€éŒ„è¡¨"></app-site-form-header>

        <!-- è¡¨å–®å…§å®¹ -->
        <!-- ç¬¬ä¸€è¡Œï¼šç·¨è™Ÿã€é–‹ç«‹äººå“¡ -->
        <div class="d-flex border border-dark">
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">ç·¨è™Ÿ(å–®ä½-å·¥è™Ÿ-å¹´/æœˆ/æµæ°´è™Ÿ)ï¼š</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
            <input type="text" class="form-control table-input" [(ngModel)]="issueRecord.recordNo" name="recordNo"
              title="ç·¨è™Ÿ" />
          </div>
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">é–‹ç«‹äººå“¡</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
            <input type="text" class="form-control table-input" [(ngModel)]="issueRecord.establishPerson"
              name="establishPerson" placeholder="è«‹è¼¸å…¥é–‹ç«‹äººå“¡" title="é–‹ç«‹äººå“¡" required />
          </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šé–‹ç«‹å–®ä½ã€å°ˆæ¡ˆç·¨è™Ÿ -->
        <div class="d-flex border border-dark border-top-0">
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">é–‹ç«‹å–®ä½</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
            <input type="text" class="form-control table-input" [(ngModel)]="issueRecord.establishUnit"
              name="establishUnit" placeholder="è«‹è¼¸å…¥é–‹ç«‹å–®ä½" title="é–‹ç«‹å–®ä½" required />
          </div>
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">å°ˆæ¡ˆç·¨è™Ÿ</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
            <input type="text" class="form-control table-input" value="{{ site()?.projectNo || '' }}" readonly
              title="å°ˆæ¡ˆç·¨è™Ÿ" />
          </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šé–‹ç«‹æ—¥æœŸã€ç¼ºå¤±è²¬ä»»å–®ä½ -->
        <div class="d-flex border border-dark border-top-0">
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">é–‹ç«‹æ—¥æœŸ</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
            <input type="date" class="form-control table-input" [(ngModel)]="issueRecord.applyDate"
              name="applyDate" title="é–‹ç«‹æ—¥æœŸ" />
          </div>
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">ç¼ºå¤±è²¬ä»»å–®ä½</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
            <div class="d-flex flex-column gap-2 w-100">
              <div class="d-flex align-items-center">
                <div class="form-check me-2">
                  <input class="form-check-input" type="radio" name="responsibleUnit" id="responsibleUnit_MIC"
                    value="MIC" [(ngModel)]="issueRecord.responsibleUnit" title="é¸æ“‡MIC" />
                  <label class="form-check-label" for="responsibleUnit_MIC">
                    MIC
                  </label>
                </div>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="issueRecord.responsibleUnitName"
                  name="responsibleUnitName" placeholder="è«‹è¼¸å…¥MICå–®ä½åç¨±" title="MICå–®ä½åç¨±"
                  [disabled]="issueRecord.responsibleUnit !== 'MIC'"
                  style="border-bottom: 1px solid #000; border-top: none; border-left: none; border-right: none; border-radius: 0;" />
              </div>
              <div class="d-flex align-items-center">
                <div class="form-check me-2">
                  <input class="form-check-input" type="radio" name="responsibleUnit" id="responsibleUnit_supplier"
                    value="supplier" [(ngModel)]="issueRecord.responsibleUnit" title="é¸æ“‡ä¾›æ‡‰å•†" />
                  <label class="form-check-label" for="responsibleUnit_supplier">
                    ä¾›æ‡‰å•†
                  </label>
                </div>
                <input type="text" class="form-control form-control-sm" [(ngModel)]="issueRecord.supplierName"
                  name="supplierName" placeholder="è«‹è¼¸å…¥ä¾›æ‡‰å•†åç¨±" title="ä¾›æ‡‰å•†åç¨±"
                  [disabled]="issueRecord.responsibleUnit !== 'supplier'"
                  style="border-bottom: 1px solid #000; border-top: none; border-left: none; border-right: none; border-radius: 0;" />
              </div>
            </div>
          </div>
        </div>

        <!-- ç¬¬å››è¡Œï¼šç¼ºå¤±æ—¥æœŸ -->
        <div class="d-flex border border-dark border-top-0">
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">ç¼ºå¤±æ—¥æœŸ</span>
          </div>
          <div style="width: 85%" class="d-flex align-items-center py-2 px-2">
            <input type="date" class="form-control table-input" [(ngModel)]="issueRecord.issueDate" name="issueDate"
              title="ç¼ºå¤±æ—¥æœŸ" style="width: 200px;" />
          </div>
        </div>

        <!-- ç¬¬äº”è¡Œï¼šç™¼ç”Ÿå» å€/åœ°é» -->
        <div class="d-flex border border-dark border-top-0">
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">ç™¼ç”Ÿå» å€/åœ°é»</span>
          </div>
          <div style="width: 85%" class="d-flex align-items-center py-2 px-2">
            <input type="text" class="form-control table-input" [(ngModel)]="issueRecord.factoryArea" name="factoryArea"
              placeholder="è«‹è¼¸å…¥ç™¼ç”Ÿå» å€/åœ°é»" title="ç™¼ç”Ÿå» å€/åœ°é»" />
          </div>
        </div>

        <!-- ç¼ºå¤±èªªæ˜ï¼†ç…§ç‰‡é»è²¼è™• -->
        <div class="border border-dark border-top-0">
          <div class="d-flex justify-content-between align-items-center py-2 px-2 bg-light">
            <span class="fw-bold">ç¼ºå¤±èªªæ˜ï¼†ç…§ç‰‡é»è²¼è™•ï¼š</span>
            <div class="d-flex gap-2">
              <label for="photoUpload" class="btn btn-sm btn-primary" title="ä¸Šå‚³ç¼ºå¤±ç…§ç‰‡">
                <i class="fas fa-camera me-1"></i>æ–°å¢ç…§ç‰‡
                <input type="file" id="photoUpload" accept="image/*" multiple hidden
                  (change)="onPhotoSelected($event)" />
              </label>
            </div>
          </div>
          <div class="p-3">
            <textarea class="form-control table-input" rows="10" [(ngModel)]="issueRecord.issueDescription"
              name="issueDescription" placeholder="è«‹è¼¸å…¥ç¼ºå¤±èªªæ˜æˆ–ç…§ç‰‡æè¿°" title="ç¼ºå¤±èªªæ˜ï¼†ç…§ç‰‡é»è²¼è™•"></textarea>

            <!-- ä¸Šå‚³é€²åº¦æ¢ -->
            @if (isUploadingPhoto()) {
            <div class="mt-3">
              <div class="progress mb-2">
                <div class="progress-bar" role="progressbar" [style.width.%]="uploadProgress()"
                  [attr.aria-valuenow]="uploadProgress()" aria-valuemin="0" aria-valuemax="100">
                  {{ uploadProgress() }}%
                </div>
              </div>
              <p class="text-muted small">æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...</p>
            </div>
            }

            <!-- å·²ä¸Šå‚³çš„ç…§ç‰‡ -->
            @if (uploadedPhotos().length > 0) {
            <div class="mt-3">
              <h6 class="mb-2">å·²ä¸Šå‚³ç…§ç‰‡ï¼š<small class="text-muted">ï¼ˆé»æ“Šç…§ç‰‡å¯æŸ¥çœ‹å¤§åœ–ä¸¦ç·¨è¼¯å‚™è¨»ï¼‰</small></h6>
              <div class="row g-2">
                @for (photo of uploadedPhotos(); track photo.filename; let i = $index) {
                <div class="col-md-3">
                  <div class="card position-relative photo-card">
                    <img [src]="photoService.getPhotoThumbnailUrl(photo.filename)" [alt]="photo.title"
                      [title]="photo.title" class="card-img-top"
                      style="height: 120px; object-fit: cover; cursor: pointer;" loading="lazy"
                      (click)="viewPhoto(i)" />
                    <button class="btn btn-danger btn-sm photo-delete-btn position-absolute" (click)="deletePhoto(i)"
                      title="åˆªé™¤ç…§ç‰‡"
                      style="top: 5px; right: 5px; width: 30px; height: 30px; padding: 0; opacity: 0; transition: opacity 0.2s ease;">
                      <i class="fas fa-times"></i>
                    </button>
                    <div class="card-body p-2">
                      <select class="form-select form-select-sm" [value]="photo.improvementStatus"
                        (change)="onImprovementStatusChange($event, i)" title="é¸æ“‡æ”¹å–„ç‹€æ…‹">
                        @for (option of improvementStatusOptions; track option.value) {
                        <option [value]="option.value">{{ option.label }}</option>
                        }
                      </select>
                    </div>
                  </div>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>

        <!-- ç¼ºå¤±è™•ç½® -->
        <div class="border border-dark border-top-0">
          <div class="d-flex align-items-center py-2 px-2 bg-light">
            <span class="fw-bold">ç¼ºå¤±è™•ç½®ï¼š</span>
          </div>
          <div class="p-3">
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="remedy_immediate"
                  [checked]="issueRecord.remedyMeasures.includes('immediate')"
                  (change)="toggleRemedyMeasure('immediate')" title="é¸æ“‡ç«‹å³å®Œæˆæ”¹æ­£" />
                <label class="form-check-label" for="remedy_immediate">
                  1. å·²ç«‹å³å®Œæˆæ”¹æ­£
                </label>
              </div>
            </div>
            <div class="mb-3">
              <div class="form-check d-flex align-items-center">
                <input class="form-check-input me-2" type="checkbox" id="remedy_deadline"
                  [checked]="issueRecord.remedyMeasures.includes('improvementWithDeadline')"
                  (change)="toggleRemedyMeasure('improvementWithDeadline')" title="é¸æ“‡é™æœŸæ”¹å–„å®Œæˆæ™‚é–“" />
                <label class="form-check-label d-flex align-items-center" for="remedy_deadline">
                  é™æœŸæ”¹å–„å®Œæˆæ™‚é–“
                  <input type="date" class="form-control mx-2" style="width: 150px;"
                    [(ngModel)]="issueRecord.improvementDeadline" name="improvementDeadline" title="æ”¹å–„å®Œæˆæ™‚é–“" autocomplete="off" />
                </label>
              </div>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="remedy_report"
                [checked]="issueRecord.remedyMeasures.includes('correctivePreventionReport')"
                (change)="toggleRemedyMeasure('correctivePreventionReport')" title="é¸æ“‡æå‡ºçŸ¯æ­£é é˜²æªæ–½å ±å‘Š" />
              <label class="form-check-label" for="remedy_report">
                2. é ˆæå‡ºçŸ¯æ­£é é˜²æªæ–½å ±å‘Š
              </label>
            </div>
          </div>
        </div>

        <!-- ç¼ºå¤±è©•æ ¸ -->
        <div class="border border-dark border-top-0">
          <div class="d-flex align-items-center py-2 px-2 bg-light">
            <span class="fw-bold">ç¼ºå¤±è©•æ ¸(è«‹åƒé–±å·¥å®‰ç¼ºå¤±æ‰£é»è¡¨ä¹‹è¨˜é»é»æ•¸)</span>
          </div>
          <div class="p-3">
            <div class="row">
              <div class="col-md-6 mb-2">
                <div class="d-flex align-items-center">
                  <label class="form-label me-2 mb-0" style="width: 80px;">ç¼ºå¤±ä»£ç¢¼ï¼š<span
                      class="text-danger">*</span></label>
                  <input type="text" class="form-control" [(ngModel)]="issueRecord.deductionCode" name="deductionCode"
                    placeholder="è«‹è¼¸å…¥ç¼ºå¤±ä»£ç¢¼" title="ç¼ºå¤±ä»£ç¢¼" required />
                </div>
              </div>
              <div class="col-md-6 mb-2">
                <div class="d-flex align-items-center">
                  <label class="form-label me-2 mb-0" style="width: 80px;">è¨˜é»é»æ•¸ï¼š</label>
                  <input type="text" class="form-control" [(ngModel)]="issueRecord.recordPoints" name="recordPoints"
                    placeholder="è«‹è¼¸å…¥è¨˜é»é»æ•¸" title="è¨˜é»é»æ•¸" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- è¤‡æŸ¥è³‡è¨Š -->
        <div class="border border-dark border-top-0">
          <div class="d-flex">
            <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
              <span class="fw-normal">è¤‡æŸ¥æ—¥æœŸï¼š</span>
            </div>
            <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
              <input type="date" class="form-control table-input" [(ngModel)]="issueRecord.reviewDate" name="reviewDate"
                title="è¤‡æŸ¥æ—¥æœŸ" />
            </div>
            <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
              <span class="fw-normal">è¤‡æŸ¥è€…ï¼š</span>
            </div>
            <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
              <input type="text" class="form-control table-input" [(ngModel)]="issueRecord.reviewer" name="reviewer"
                placeholder="è«‹è¼¸å…¥è¤‡æŸ¥è€…" title="è¤‡æŸ¥è€…" />
            </div>
          </div>
        </div>

        <!-- è¿½è¹¤è¤‡æŸ¥çµæœ -->
        <div class="border border-dark border-top-0">
          <div class="p-3">
            <div class="mb-2 fw-bold">è¿½è¹¤è¤‡æŸ¥çµæœï¼š</div>
            <div class="d-flex gap-4">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reviewResult" id="reviewResult_completed"
                  value="completed" [(ngModel)]="issueRecord.reviewResult" title="é¸æ“‡å·²å®Œæˆæ”¹æ­£" />
                <label class="form-check-label" for="reviewResult_completed">
                  å·²å®Œæˆæ”¹æ­£
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reviewResult" id="reviewResult_incomplete"
                  value="incomplete" [(ngModel)]="issueRecord.reviewResult" title="é¸æ“‡æœªå®Œæˆæ”¹æ­£" />
                <label class="form-check-label" for="reviewResult_incomplete">
                  æœªå®Œæˆæ”¹æ­£(è¦æ±‚æ”¹å–„ï¼Œå†æ¬¡é–‹ç«‹å·¥å®‰ç¼ºå¤±ç´€éŒ„è¡¨)
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- ç°½åå€åŸŸ -->
        <div class="mt-4">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-light text-center fw-bold">ç›£å·¥ç°½å</div>
                <div class="card-body text-center">
                  <div class="signature mb-2" (click)="openSignatureDialog(SignatureType.Supervisor)"
                    style="min-height: 120px; cursor: pointer;">
                    @if (supervisorSignature) {
                    <img [src]="supervisorSignature" alt="ç›£å·¥ç°½å" class="img-fluid" style="max-height: 150px"
                      title="ç›£å·¥ç°½å" />
                    } @else {
                    <div class="p-3 border rounded h-100 d-flex align-items-center justify-content-center">
                      <div class="text-muted">
                        <i class="fas fa-edit"></i>
                        <br>é»æ“Šæ­¤è™•é€²è¡Œç°½å
                      </div>
                    </div>
                    }
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header bg-light text-center fw-bold">ä½œæ¥­äººå“¡ç°½å</div>
                <div class="card-body text-center">
                  <div class="signature mb-2" (click)="openSignatureDialog(SignatureType.Worker)"
                    style="min-height: 120px; cursor: pointer;">
                    @if (workerSignature) {
                    <img [src]="workerSignature" alt="ä½œæ¥­äººå“¡ç°½å" class="img-fluid" style="max-height: 150px"
                      title="ä½œæ¥­äººå“¡ç°½å" />
                    } @else {
                    <div class="p-3 border rounded h-100 d-flex align-items-center justify-content-center">
                      <div class="text-muted">
                        <i class="fas fa-edit"></i>
                        <br>é»æ“Šæ­¤è™•é€²è¡Œç°½å
                      </div>
                    </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœ¬å–®æµç¨‹ -->
        <div class="border border-dark mt-4">
          <div class="d-flex align-items-center py-2 px-2 bg-light">
            <span class="fw-bold">æœ¬å–®æµç¨‹ï¼š</span>
          </div>
          <div class="p-3">
            <p class="mb-2">MICç›£å·¥å–®ä½é–‹å–®è€…ï¼šæ­£æœ¬(MICç›£å·¥å–®ä½)ã€å‰¯æœ¬(ç¼ºå¤±è²¬ä»»å–®ä½ã€M8)</p>
            <p class="mb-0">MIC M8é–‹å–®è€…ï¼šæ­£æœ¬(MIC M8)ã€å‰¯æœ¬(ç¼ºå¤±è²¬ä»»å–®ä½ã€MICç›£å·¥å–®ä½)</p>
          </div>
        </div>

        <!-- è¡¨å–®ç·¨è™Ÿ -->
        <div class="text-end mt-3">
          <small class="text-muted">EE-4411-06A</small>
        </div>

      </div>
    </div>
  </div>

  <!-- äººæ‰é¸æ“‡å¡ç‰‡ -->
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-users me-2"></i>æ¶‰åŠç¼ºå¤±äººå“¡é¸æ“‡
      </h5>
    </div>
    <div class="card-body">
      <!-- ç„¡ç‰¹å®šäººå“¡é¸é … -->
      <div class="mb-3">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="noSpecificWorker"
            [(ngModel)]="issueRecord.noSpecificWorker"
          />
          <label class="form-check-label fw-bold text-primary" for="noSpecificWorker">
            ç„¡ç‰¹å®šäººå“¡ï¼ˆç’°å¢ƒæˆ–è¨­å‚™ç¼ºå¤±ï¼Œéç‰¹å®šäººå“¡é€ æˆï¼‰
          </label>
        </div>
        @if (issueRecord.noSpecificWorker) {
          <small class="text-muted d-block mt-1">
            <i class="fas fa-info-circle me-1"></i>å·²å‹¾é¸æ­¤é …ï¼Œå¯ä¸é¸æ“‡äººå“¡ç›´æ¥å„²å­˜
          </small>
        }
      </div>

      <hr class="my-3" />

      <!-- æœå°‹å€åŸŸ -->
      <div class="row mb-3 g-2">
        <!-- é—œéµå­—æœå°‹ -->
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="searchQuery"
              (input)="onSearchWorkers()"
              placeholder="æœå°‹äººæ‰ï¼ˆå§“åã€èº«ä»½è­‰ã€é›»è©±ã€å…¬å¸åç¨±ï¼‰"
            />
          </div>
        </div>

        <!-- èªè­‰é¡å‹ç¯©é¸ -->
        <div class="col-md-5">
          <select
            class="form-select"
            [(ngModel)]="selectedCertificationType"
            (change)="onSearchWorkers()"
          >
            <option value="">å…¨éƒ¨èªè­‰é¡å‹</option>
            @for (certType of certificationTypes; track certType.code) {
              <option [value]="certType.code">
                {{ certType.name }} ({{ getCertificationCount(certType.code) }})
              </option>
            }
          </select>
        </div>

        <!-- æ¸…é™¤æŒ‰éˆ• -->
        <div class="col-md-1">
          <button
            type="button"
            class="btn btn-outline-secondary w-100"
            (click)="clearFilters()"
            title="æ¸…é™¤æ‰€æœ‰éæ¿¾æ¢ä»¶"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- å·²é¸æ“‡çš„äººæ‰ -->
      @if (selectedWorkerObjects.length > 0) {
        <div class="mb-3">
          <label class="form-label fw-bold">å·²é¸æ“‡äººå“¡ ({{ selectedWorkerObjects.length }})</label>
          <div class="d-flex flex-wrap gap-2">
            @for (worker of selectedWorkerObjects; track worker._id) {
              <span class="badge bg-danger d-flex align-items-center" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                {{ worker.name }}
                @if (worker.contractingCompanyName) {
                  <small class="ms-1">({{ worker.contractingCompanyName }})</small>
                }
                <button
                  type="button"
                  class="btn-close btn-close-white ms-2"
                  style="font-size: 0.7rem;"
                  (click)="removeSelectedWorker(worker._id!)"
                  title="ç§»é™¤"
                ></button>
              </span>
            }
          </div>
        </div>
      }

      <!-- å¯é¸æ“‡çš„äººæ‰åˆ—è¡¨ -->
      <div>
        <label class="form-label fw-bold">å¯é¸æ“‡äººå“¡</label>
        <div class="border rounded" style="max-height: 300px; overflow-y: auto;">
          @if (filteredWorkers.length === 0) {
            <div class="text-center text-muted p-3">
              @if (searchQuery) {
                æ²’æœ‰ç¬¦åˆæœå°‹æ¢ä»¶çš„äººæ‰
              } @else {
                æ­¤å·¥åœ°å°šç„¡äººæ‰è³‡æ–™
              }
            </div>
          } @else {
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width: 50px"></th>
                  <th style="width: 100px">å§“å</th>
                  <th style="width: 150px">å…¬å¸</th>
                  <th style="width: 110px">é›»è©±</th>
                  <th style="width: 120px">èº«ä»½è­‰</th>
                  <th>èªè­‰è³‡æ–™</th>
                </tr>
              </thead>
              <tbody>
                @for (worker of filteredWorkers; track worker._id) {
                  <tr
                    (click)="toggleWorkerSelection(worker)"
                    style="cursor: pointer;"
                    [class.table-active]="isWorkerSelected(worker._id!)"
                  >
                    <td class="text-center">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        [checked]="isWorkerSelected(worker._id!)"
                        (click)="$event.stopPropagation()"
                        (change)="toggleWorkerSelection(worker)"
                      />
                    </td>
                    <td>{{ worker.name }}</td>
                    <td>{{ worker.contractingCompanyName || '-' }}</td>
                    <td>{{ worker.tel || '-' }}</td>
                    <td>{{ worker.idno || '-' }}</td>
                    <td>
                      <small>{{ getWorkerCertifications(worker) }}</small>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨æŒ‰éˆ• -->
  <div class="d-flex mt-4 pt-3">
    <button type="button" class="btn btn-outline-secondary px-4" (click)="cancel()">
      <i class="fas fa-times-circle me-1"></i>å–æ¶ˆ
    </button>
    @if (currentUser()?.role === 'admin' && formId) {
    <button type="button" class="btn btn-outline-danger px-4 ms-2" (click)="deleteIssueRecord()">
      <i class="fas fa-trash me-1"></i>åˆªé™¤
    </button>
    }

    @if (issueRecord._id) {
    <div class="mx-auto">
      <button type="button" class="btn btn-success px-4" (click)="generateDocx()" [disabled]="isGeneratingDocument()">
        @if (isGeneratingDocument()) {
        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
        ç”Ÿæˆä¸­...
        } @else {
        <i class="fas fa-file-word me-1"></i>ä¸‹è¼‰Word
        }
      </button>
    </div>
    }

    <div class="ms-auto">
      <button type="button" class="btn btn-primary px-4" (click)="saveIssueRecord()">
        <i class="fas fa-save me-1"></i>å„²å­˜
      </button>
    </div>
  </div>
</div>

<!-- ç…§ç‰‡æŸ¥çœ‹ Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="photoModalLabel">
          <i class="fas fa-image me-2"></i>ç…§ç‰‡æŸ¥çœ‹
        </h5>
        <button type="button" class="btn-close" (click)="closePhotoModal()" aria-label="é—œé–‰"></button>
      </div>
      <div class="modal-body">
        @if (getCurrentPhoto()) {
        <div class="row">
          <!-- ç…§ç‰‡é¡¯ç¤ºå€ -->
          <div class="col-md-8">
            <div class="text-center">
              <img [src]="'/api/gridfs/' + getCurrentPhoto().filename" [alt]="getCurrentPhoto().title"
                class="img-fluid rounded" style="max-height: 500px; width: auto;" />
            </div>
          </div>

          <!-- ç…§ç‰‡è³‡è¨Šç·¨è¼¯å€ -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-info-circle me-1"></i>ç…§ç‰‡è³‡è¨Š
                </h6>
              </div>
              <div class="card-body">
                <!-- æ”¹å–„ç‹€æ…‹ -->
                <div class="mb-3">
                  <label class="form-label">æ”¹å–„ç‹€æ…‹</label>
                  <select class="form-select" [value]="getCurrentPhoto().improvementStatus"
                    (change)="onImprovementStatusChange($event, currentPhotoIndex())">
                    @for (option of improvementStatusOptions; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                </div>

                <!-- ç…§ç‰‡æ¨™é¡Œ/å‚™è¨» -->
                <div class="mb-3">
                  <label class="form-label">ç…§ç‰‡æ¨™é¡Œ/å‚™è¨»</label>
                  <textarea class="form-control" rows="4" [(ngModel)]="editingPhotoTitle"
                    placeholder="è«‹è¼¸å…¥ç…§ç‰‡æ¨™é¡Œæˆ–å‚™è¨»..."></textarea>
                  <div class="form-text">
                    å¯ä»¥åœ¨æ­¤æè¿°ç…§ç‰‡å…§å®¹ã€ç¼ºå¤±è©³æƒ…æˆ–æ”¹å–„æªæ–½ç­‰ã€‚
                  </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="d-grid gap-2">
                  <button type="button" class="btn btn-primary" (click)="savePhotoTitle()">
                    <i class="fas fa-save me-1"></i>å„²å­˜å‚™è¨»
                  </button>
                  <button type="button" class="btn btn-outline-danger" (click)="deletePhoto(currentPhotoIndex())">
                    <i class="fas fa-trash me-1"></i>åˆªé™¤ç…§ç‰‡
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePhotoModal()">
          é—œé–‰
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .photo-card:hover .photo-delete-btn {
    opacity: 1 !important;
  }

  .photo-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .photo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .photo-delete-btn {
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .photo-delete-btn:hover {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
  }

  .card-img-top {
    transition: all 0.2s ease;
  }

  .card-img-top:hover {
    opacity: 0.8;
    transform: scale(1.02);
  }

  .photo-card .card-img-top {
    position: relative;
  }

  .photo-card:hover .card-img-top::after {
    content: "ğŸ” é»æ“ŠæŸ¥çœ‹";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    pointer-events: none;
  }
</style>