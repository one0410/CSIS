<div class="container-fluid bg-light min-vh-100 p-3">
  <div class="card form-card shadow-sm">
    <div class="card-body p-4">
      <!-- 實際表單內容容器 -->
      <div class="print-content">
        <!-- 表單頭部 -->
      <div class="d-flex justify-content-between align-items-center mb-3 pb-2">
        <div>
         <!-- @if (site()?.formLogo) {
          <img
            [src]="site()?.formLogo"
            alt="公司Logo"
            class="img-fluid"
            style="max-width: 100px; max-height: 100px"
          />
          } -->
          <img
            src="assets/miclogo.jpg"
            alt="公司Logo"
            title="公司Logo"
            class="img-fluid"
            style="max-width: 100px; max-height: 100px"
          />
        </div>
        <div class="form-title text-center fw-bold p-2 flex-grow-1 mx-3">
          <h5 class="m-0 fw-bold">帆宣系統科技南科分公司</h5>
          <h6 class="m-0 fw-bold fst-italic">
            Marketech International Corp.
          </h6>
          <h5 class="m-1 fw-bold">工安缺失紀錄表</h5>
        </div>
        <div style="width: 100px"></div>
      </div>

      <!-- 表單內容 -->
      <!-- 第一行：編號、開立人員 -->
      <div class="d-flex border border-dark">
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">編號(單位-工號-年/月/流水號)：</span>
        </div>
        <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
          <input 
            type="text" 
            class="form-control border-0 bg-transparent p-0" 
            [(ngModel)]="issueRecord.recordNo"
            name="recordNo"
            title="編號"
          />
        </div>
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">開立人員</span>
        </div>
        <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
          <input 
            type="text" 
            class="form-control border-0 bg-transparent p-0" 
            [(ngModel)]="issueRecord.establishPerson"
            name="establishPerson"
            placeholder="請輸入開立人員"
            title="開立人員"
            required
          />
        </div>
      </div>

      <!-- 第二行：開立單位、專案編號 -->
      <div class="d-flex border border-dark border-top-0">
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">開立單位</span>
        </div>
        <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
          <input 
            type="text" 
            class="form-control border-0 bg-transparent p-0" 
            [(ngModel)]="issueRecord.establishUnit"
            name="establishUnit"
            placeholder="請輸入開立單位"
            title="開立單位"
            required
          />
        </div>
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">專案編號</span>
        </div>
        <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
          <input 
            type="text" 
            class="form-control border-0 bg-transparent p-0" 
            value="{{ site()?.projectNo || '' }}"
            readonly
            title="專案編號"
          />
        </div>
      </div>

      <!-- 第三行：開立日期、缺失責任單位 -->
      <div class="d-flex border border-dark border-top-0">
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">開立日期</span>
        </div>
        <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
          <input 
            type="date" 
            class="form-control border-0 bg-transparent p-0" 
            [(ngModel)]="issueRecord.establishDate"
            name="establishDate"
            title="開立日期"
          />
        </div>
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">缺失責任單位</span>
        </div>
        <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
          <div class="d-flex gap-3">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="radio" 
                name="responsibleUnit" 
                id="responsibleUnit_MIC"
                value="MIC"
                [(ngModel)]="issueRecord.responsibleUnit"
                title="選擇MIC"
              />
              <label class="form-check-label" for="responsibleUnit_MIC">
                MIC
              </label>
            </div>
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="radio" 
                name="responsibleUnit" 
                id="responsibleUnit_supplier"
                value="supplier"
                [(ngModel)]="issueRecord.responsibleUnit"
                title="選擇供應商"
              />
              <label class="form-check-label" for="responsibleUnit_supplier">
                供應商
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 第四行：缺失日期 -->
      <div class="d-flex border border-dark border-top-0">
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">缺失日期</span>
        </div>
        <div style="width: 85%" class="d-flex align-items-center py-2 px-2">
          <input 
            type="date" 
            class="form-control border-0 bg-transparent p-0" 
            [(ngModel)]="issueRecord.issueDate"
            name="issueDate"
            title="缺失日期"
            style="width: 200px;"
          />
        </div>
      </div>

      <!-- 第五行：發生廠區/地點 -->
      <div class="d-flex border border-dark border-top-0">
        <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
          <span class="fw-normal">發生廠區/地點</span>
        </div>
        <div style="width: 85%" class="d-flex align-items-center py-2 px-2">
          <input 
            type="text" 
            class="form-control border-0 bg-transparent p-0" 
            [(ngModel)]="issueRecord.factoryArea"
            name="factoryArea"
            placeholder="請輸入發生廠區/地點"
            title="發生廠區/地點"
          />
        </div>
      </div>

      <!-- 缺失說明及照片黏貼處 -->
      <div class="border border-dark border-top-0">
        <div class="d-flex justify-content-between align-items-center py-2 px-2 bg-light">
          <span class="fw-bold">缺失說明及照片黏貼處：</span>
          <div class="d-flex gap-2">
            <label 
              for="photoUpload" 
              class="btn btn-sm btn-primary"
              title="上傳缺失照片"
            >
              <i class="bi bi-camera me-1"></i>新增照片
              <input
                type="file"
                id="photoUpload"
                accept="image/*"
                multiple
                hidden
                (change)="onPhotoSelected($event)"
              />
            </label>
          </div>
        </div>
        <div class="p-3">
          <textarea 
            class="form-control border-0 bg-transparent p-0" 
            rows="10"
            [(ngModel)]="issueRecord.issueDescription"
            name="issueDescription"
            placeholder="請輸入缺失說明或照片描述"
            title="缺失說明及照片黏貼處"
          ></textarea>
          
          <!-- 上傳進度條 -->
          @if (isUploadingPhoto()) {
          <div class="mt-3">
            <div class="progress mb-2">
              <div
                class="progress-bar"
                role="progressbar"
                [style.width.%]="uploadProgress()"
                [attr.aria-valuenow]="uploadProgress()"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {{ uploadProgress() }}%
              </div>
            </div>
            <p class="text-muted small">正在上傳照片，請勿關閉視窗...</p>
          </div>
          }
          
                     <!-- 已上傳的照片 -->
           @if (uploadedPhotos().length > 0) {
           <div class="mt-3">
             <h6 class="mb-2">已上傳照片：</h6>
             <div class="row g-2">
               @for (photo of uploadedPhotos(); track photo.filename; let i = $index) {
               <div class="col-md-3">
                 <div class="card position-relative photo-card">
                   <img 
                     [src]="photo.url" 
                     [alt]="photo.title"
                     [title]="photo.title"
                     class="card-img-top" 
                     style="height: 120px; object-fit: cover;"
                     loading="lazy"
                   />
                   <button 
                     class="btn btn-danger btn-sm photo-delete-btn position-absolute" 
                     (click)="deletePhoto(i)"
                     title="刪除照片"
                     style="top: 5px; right: 5px; width: 30px; height: 30px; padding: 0; opacity: 0; transition: opacity 0.2s ease;"
                   >
                     <i class="bi bi-x-lg"></i>
                   </button>
                   <div class="card-body p-2">
                     <p class="card-text small mb-0">{{ photo.title }}</p>
                   </div>
                 </div>
               </div>
               }
             </div>
           </div>
           }
        </div>
      </div>

      <!-- 缺失處置 -->
      <div class="border border-dark border-top-0">
        <div class="d-flex align-items-center py-2 px-2 bg-light">
          <span class="fw-bold">缺失處置：</span>
        </div>
        <div class="p-3">
          <div class="mb-3">
            <div class="form-check d-flex align-items-center">
              <input 
                class="form-check-input me-2" 
                type="checkbox" 
                id="remedy_immediate"
                [checked]="issueRecord.remedyMeasures.includes('immediate')"
                (change)="toggleRemedyMeasure('immediate')"
                title="選擇立即完成改正"
              />
              <label class="form-check-label d-flex align-items-center" for="remedy_immediate">
                1. 已立即完成改正 限期改善完成時間
                <input 
                  type="date" 
                  class="form-control mx-2 border-bottom border-0 bg-transparent" 
                  style="width: 150px;"
                  [(ngModel)]="issueRecord.improvementDeadline"
                  name="improvementDeadline"
                  title="改善完成時間"
                />
              </label>
            </div>
          </div>
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="checkbox" 
              id="remedy_report"
              [checked]="issueRecord.remedyMeasures.includes('report')"
              (change)="toggleRemedyMeasure('report')"
              title="選擇提出矯正預防措施報告"
            />
            <label class="form-check-label" for="remedy_report">
              2. 須提出矯正預防措施報告
            </label>
          </div>
        </div>
      </div>

      <!-- 缺失評核 -->
      <div class="border border-dark border-top-0">
        <div class="d-flex align-items-center py-2 px-2 bg-light">
          <span class="fw-bold">缺失評核(請參閱工安缺失扣點表之記點點數)</span>
        </div>
        <div class="p-3">
          <div class="row">
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <label class="form-label me-2 mb-0" style="width: 80px;">缺失代碼：</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="issueRecord.deductionCode"
                  name="deductionCode"
                  placeholder="請輸入缺失代碼"
                  title="缺失代碼"
                />
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <label class="form-label me-2 mb-0" style="width: 80px;">記點點數：</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="issueRecord.recordPoints"
                  name="recordPoints"
                  placeholder="請輸入記點點數"
                  title="記點點數"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 複查資訊 -->
      <div class="border border-dark border-top-0">
        <div class="d-flex">
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">複查日期：</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center border-end border-dark py-2 px-2">
            <input 
              type="date" 
              class="form-control border-0 bg-transparent p-0" 
              [(ngModel)]="issueRecord.reviewDate"
              name="reviewDate"
              title="複查日期"
            />
          </div>
          <div style="width: 15%" class="d-flex align-items-center border-end border-dark py-2 px-2 bg-light">
            <span class="fw-normal">複查者：</span>
          </div>
          <div style="width: 35%" class="d-flex align-items-center py-2 px-2">
            <input 
              type="text" 
              class="form-control border-0 bg-transparent p-0" 
              [(ngModel)]="issueRecord.reviewer"
              name="reviewer"
              placeholder="請輸入複查者"
              title="複查者"
            />
          </div>
        </div>
      </div>

      <!-- 追蹤複查結果 -->
      <div class="border border-dark border-top-0">
        <div class="p-3">
          <div class="mb-2 fw-bold">追蹤複查結果：</div>
          <div class="d-flex gap-4">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="radio" 
                name="reviewResult" 
                id="reviewResult_completed"
                value="completed"
                [(ngModel)]="issueRecord.reviewResult"
                title="選擇已完成改正"
              />
              <label class="form-check-label" for="reviewResult_completed">
                已完成改正
              </label>
            </div>
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="radio" 
                name="reviewResult" 
                id="reviewResult_incomplete"
                value="incomplete"
                [(ngModel)]="issueRecord.reviewResult"
                title="選擇未完成改正"
              />
              <label class="form-check-label" for="reviewResult_incomplete">
                未完成改正(要求改善，再次開立工安缺失紀錄表)
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 簽名區域 -->
      <div class="mt-4">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-light text-center fw-bold">監工簽名</div>
              <div class="card-body text-center">
                <div
                  class="signature mb-2"
                  (click)="openSignatureDialog(SignatureType.Supervisor)"
                  style="min-height: 120px; cursor: pointer;"
                >
                  @if (supervisorSignature) {
                  <img
                    [src]="supervisorSignature"
                    alt="監工簽名"
                    class="img-fluid"
                    style="max-height: 150px"
                    title="監工簽名"
                  />
                  } @else {
                  <div class="p-3 border rounded h-100 d-flex align-items-center justify-content-center">
                    <div class="text-muted">
                      <i class="bi bi-pencil-square"></i> 
                      <br>點擊此處進行簽名
                    </div>
                  </div>
                  }
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-light text-center fw-bold">作業人員簽名</div>
              <div class="card-body text-center">
                <div
                  class="signature mb-2"
                  (click)="openSignatureDialog(SignatureType.Worker)"
                  style="min-height: 120px; cursor: pointer;"
                >
                  @if (workerSignature) {
                  <img
                    [src]="workerSignature"
                    alt="作業人員簽名"
                    class="img-fluid"
                    style="max-height: 150px"
                    title="作業人員簽名"
                  />
                  } @else {
                  <div class="p-3 border rounded h-100 d-flex align-items-center justify-content-center">
                    <div class="text-muted">
                      <i class="bi bi-pencil-square"></i> 
                      <br>點擊此處進行簽名
                    </div>
                  </div>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 本單流程 -->
      <div class="border border-dark mt-4">
        <div class="d-flex align-items-center py-2 px-2 bg-light">
          <span class="fw-bold">本單流程：</span>
        </div>
        <div class="p-3">
          <p class="mb-2">MIC監工單位開單者：正本(MIC監工單位)、副本(缺失責任單位、M8)</p>
          <p class="mb-0">MIC M8開單者：正本(MIC M8)、副本(缺失責任單位、MIC監工單位)</p>
        </div>
      </div>

      <!-- 表單編號 -->
      <div class="text-end mt-3">
        <small class="text-muted">EE-4411-06A</small>
      </div>

      <!-- 底部按鈕 -->
      <div class="d-flex justify-content-center gap-3 mt-4 pt-3">
        <button class="btn btn-primary px-4" (click)="saveIssueRecord()">
          <i class="bi bi-save me-1"></i>保存
        </button>
        <button class="btn btn-outline-secondary px-4" (click)="cancel()">
          <i class="bi bi-x-circle me-1"></i>取消
        </button>
      </div>
      </div>
    </div>
  </div>
</div> 