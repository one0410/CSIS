<div class="container-fluid h-100">
  <!-- 頁面標題與工具列 -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>
          <i class="fas fa-calendar-alt me-2"></i>
          新進度表 - {{ site()?.projectName }}
        </h4>

        <div class="d-flex gap-2">
          <!-- 檢視模式切換 -->
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewMode" id="day" value="day" [checked]="viewMode === 'day'"
              (change)="changeViewMode('day')">
            <label class="btn btn-outline-primary btn-sm" for="day">日</label>

            <input type="radio" class="btn-check" name="viewMode" id="week" value="week" [checked]="viewMode === 'week'"
              (change)="changeViewMode('week')">
            <label class="btn btn-outline-primary btn-sm" for="week">週</label>

            <input type="radio" class="btn-check" name="viewMode" id="month" value="month"
              [checked]="viewMode === 'month'" (change)="changeViewMode('month')">
            <label class="btn btn-outline-primary btn-sm" for="month">月</label>
          </div>

          <!-- XML 匯入按鈕 -->
          <button class="btn btn-success btn-sm" (click)="fileInput.click()">
            <i class="fas fa-file-import me-1"></i>匯入 XML
          </button>
          <input #fileInput type="file" accept=".xml" style="display: none" (change)="onFileSelected($event)">

          <!-- 新增任務按鈕 -->
          <button class="btn btn-primary btn-sm" (click)="addNewTask()">
            <i class="fas fa-plus me-1"></i>新增任務
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 甘特圖表格 -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 600px; overflow: auto;">
            <table class="table table-sm table-bordered mb-0" [style.min-width]="getTableMinWidth()">
              <!-- 表格標題 -->
              <thead class="table-light sticky-top">
                <tr>
                  <th rowspan="2"
                    style="width: 60px; min-width: 60px; position: sticky; left: 0; z-index: 10; cursor: pointer; background-color: #f8f9fa;"
                    class="table-light" title="點擊編輯任務">WBS</th>
                  <th rowspan="2"
                    style="width: 180px; min-width: 180px; position: sticky; left: 60px; z-index: 10; background-color: #f8f9fa;"
                    class="table-light" title="點擊直接編輯">內容</th>
                  <th rowspan="2"
                    style="width: 50px; min-width: 50px; position: sticky; left: 240px; z-index: 10; background-color: #f8f9fa;"
                    class="table-light" title="點擊直接編輯">天數</th>
                                     <th rowspan="2"
                     style="width: 100px; min-width: 100px; position: sticky; left: 290px; z-index: 10; background-color: #f8f9fa;"
                     class="table-light" title="子任務可編輯，父層任務自動計算">開始日 <i class="fas fa-calculator text-muted" style="font-size: 0.7rem;"></i></th>
                   <th rowspan="2"
                     style="width: 100px; min-width: 100px; position: sticky; left: 390px; z-index: 10; background-color: #f8f9fa;"
                     class="table-light" title="子任務可編輯，父層任務自動計算">結束日 <i class="fas fa-calculator text-muted" style="font-size: 0.7rem;"></i></th>
                   <th rowspan="2"
                     style="width: 50px; min-width: 50px; position: sticky; left: 490px; z-index: 10; background-color: #f8f9fa;"
                     class="table-light" title="子任務可編輯，父層任務自動計算">權重 <i class="fas fa-calculator text-muted" style="font-size: 0.7rem;"></i></th>

                  <!-- 日期欄位 - 月份標題列 -->
                  @for (monthGroup of monthGroups; track monthGroup.month) {
                  <th [attr.colspan]="monthGroup.span"
                    style="width: auto; min-width: 60px; text-align: center; border-bottom: 1px solid #dee2e6;">
                    {{ monthGroup.month }}
                  </th>
                  }
                </tr>
                <tr>
                  <!-- 日期欄位 - 日期/週數/日期範圍 -->
                  @for (dateCol of dateColumns; track dateCol) {
                  <th [style.width]="getDateColumnWidth()" [style.min-width]="getDateColumnWidth()"
                    style="text-align: center; font-size: 0.75rem; border-top: none;">
                    {{ getDateSubtitle(dateCol) }}
                  </th>
                  }
                </tr>
              </thead>

              <!-- 表格內容 -->
              <tbody>
                @for (task of flatTasks; track task.wbs) {
                <!-- 任務基本資訊列 -->
                <tr [ngClass]="{'table-secondary': hasChildren(task)}">
                  <!-- WBS -->
                  <td
                    style="width: 60px; position: sticky; left: 0; z-index: 5; cursor: pointer; background-color: #f8f9fa;"
                    [ngClass]="{'table-light': true, 'table-hover': true}" (click)="editTask(task)" title="點擊編輯任務">
                    <div class="d-flex align-items-center">
                      @if (hasChildren(task)) {
                      <button class="btn btn-sm btn-outline-secondary me-1 p-0"
                        style="width: 16px; height: 16px; font-size: 8px;"
                        (click)="$event.stopPropagation(); toggleTaskExpansion(task)">
                        <i [ngClass]="task.isExpanded ? 'fas fa-minus' : 'fas fa-plus'"></i>
                      </button>
                      }
                      <small [ngClass]="getIndentClass(task.level)" style="font-size: 0.7rem;">{{
                        task.wbs }}</small>
                    </div>
                  </td>

                  <!-- 內容 -->
                  <td style="width: 180px; position: sticky; left: 60px; z-index: 5; background-color: #f8f9fa;"
                    [ngClass]="{'table-light': true}">
                    <input type="text" class="form-control form-control-sm border-0 bg-transparent p-1"
                      style="font-size: 0.75rem; height: auto;" [(ngModel)]="task.name" (blur)="saveTaskFieldWithType(task, 'content')"
                      (keyup.enter)="$any($event.target).blur()" [ngClass]="getIndentClass(task.level)">
                  </td>

                  <!-- 天數 -->
                  <td style="width: 50px; position: sticky; left: 240px; z-index: 5; background-color: #f8f9fa;"
                    [ngClass]="{'table-light': true}">
                    <input type="number" class="form-control form-control-sm border-0 bg-transparent p-1 text-center"
                      style="font-size: 0.7rem; height: auto;" [(ngModel)]="task.days" (blur)="saveTaskFieldWithType(task, 'days')"
                      (keyup.enter)="$any($event.target).blur()" min="1" step="1">
                  </td>

                                     <!-- 開始日 -->
                   <td style="width: 100px; position: sticky; left: 290px; z-index: 5; background-color: #f8f9fa;"
                     [ngClass]="{'table-light': true}">
                     @if (hasChildren(task)) {
                       <!-- 父層任務：只顯示，不可編輯 -->
                       <span class="text-muted d-block text-center" style="font-size: 0.8rem; padding: 0.375rem;">
                         {{ task.startDate }}
                       </span>
                     } @else {
                       <!-- 子任務：可編輯 -->
                       <input type="date" class="form-control form-control-sm border-0 bg-transparent p-0"
                         style="font-size: 0.8rem; height: auto;" [(ngModel)]="task.startDate" (blur)="saveTaskFieldWithType(task, 'startDate')"
                         (keyup.enter)="$any($event.target).blur()">
                     }
                   </td>

                   <!-- 結束日 -->
                   <td style="width: 100px; position: sticky; left: 390px; z-index: 5; background-color: #f8f9fa;"
                     [ngClass]="{'table-light': true}">
                     @if (hasChildren(task)) {
                       <!-- 父層任務：只顯示，不可編輯 -->
                       <span class="text-muted d-block text-center" style="font-size: 0.8rem; padding: 0.375rem;">
                         {{ task.endDate }}
                       </span>
                     } @else {
                       <!-- 子任務：可編輯 -->
                       <input type="date" class="form-control form-control-sm border-0 bg-transparent p-0"
                         style="font-size: 0.8rem; height: auto;" [(ngModel)]="task.endDate" (blur)="saveTaskFieldWithType(task, 'endDate')"
                         (keyup.enter)="$any($event.target).blur()">
                     }
                   </td>

                   <!-- 權重 -->
                   <td style="width: 50px; position: sticky; left: 490px; z-index: 5; background-color: #f8f9fa;"
                     [ngClass]="{'table-light': true}">
                     @if (hasChildren(task)) {
                       <!-- 父層任務：只顯示，不可編輯 -->
                       <span class="text-muted d-block text-center" style="font-size: 0.7rem; padding: 0.375rem;">
                         {{ task.weight }}
                       </span>
                     } @else {
                       <!-- 子任務：可編輯 -->
                       <input type="number" class="form-control form-control-sm border-0 bg-transparent p-1 text-center"
                         style="font-size: 0.7rem; height: auto;" [(ngModel)]="task.weight" (blur)="saveTaskFieldWithType(task, 'weight')"
                         (keyup.enter)="$any($event.target).blur()" min="0" max="100" step="0.01">
                     }
                   </td>

                  <!-- 日期欄位 - 顯示任務時間範圍 -->
                  @for (dateCol of dateColumns; track dateCol) {
                  <td [style.width]="getDateColumnWidth()" style="text-align: center; padding: 0.1rem;"
                    [ngClass]="getTaskDateCellClass(task, dateCol)">
                    @if (isDateInRange(task, dateCol) && !hasChildren(task)) {
                    <div
                      style="width: 100%; height: 100%; background-color: #007bff; border-radius: 2px; min-height: 22px;">
                    </div>
                    }
                  </td>
                  }
                </tr>

                <!-- 最底層任務的進度輸入列 -->
                @if (!hasChildren(task)) {
                <tr class="table-warning bg-opacity-10">
                  <!-- 空白欄位對齊 -->
                                     <td colspan="6"
                     style="position: sticky; left: 0; z-index: 5; width: 540px; background-color: #f8f9fa;"
                     class="table-light">
                    <small class="text-muted ps-3" style="font-size: 0.7rem;">進度輸入</small>
                  </td>

                  <!-- 進度輸入欄位 -->
                  @for (dateCol of dateColumns; track dateCol) {
                  <td [style.width]="getDateColumnWidth()" style="text-align: center; padding: 0.1rem;">
                    @if (isDateInRange(task, dateCol)) {
                                                              <input type="number" class="form-control form-control-sm text-center"
                        [style.font-size]="viewMode === 'day' ? '8px' : '10px'"
                        [style.width]="viewMode === 'day' ? '20px' : (viewMode === 'week' ? '46px' : '70px')"
                        style="height: 20px;" min="0" max="100" [value]="getProgressForDate(task, dateCol)"
                        (input)="updateProgress(task, dateCol, +$any($event.target).value)" placeholder="0">
                    }
                  </td>
                  }
                </tr>
                }
                }

                @if (flatTasks.length === 0) {
                <tr>
                  <td colspan="100%" class="text-center text-muted py-4">
                    尚無任務資料，請新增任務或匯入 XML 檔案
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 編輯任務 Modal -->
@if (isEditing && editingTask) {
<div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">編輯任務</h5>
        <button type="button" class="btn-close" (click)="cancelEdit()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">WBS</label>
            <input type="text" class="form-control" [(ngModel)]="editingTask.wbs" name="wbs">
          </div>
          <div class="mb-3">
            <label class="form-label">任務名稱</label>
            <input type="text" class="form-control" [(ngModel)]="editingTask.name" name="name">
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">開始日期</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.startDate" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務日期由子任務自動計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="date" class="form-control" [(ngModel)]="editingTask.startDate" name="startDate">
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">結束日期</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.endDate" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務日期由子任務自動計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="date" class="form-control" [(ngModel)]="editingTask.endDate" name="endDate">
                }
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">天數</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.days" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務天數由子任務自動計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="number" class="form-control" [(ngModel)]="editingTask.days" name="days" min="1" step="1">
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">權重 (%)</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.weight" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務權重由子任務平均計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="number" class="form-control" [(ngModel)]="editingTask.weight" name="weight" min="0"
                    max="100" step="0.01">
                }
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" (click)="deleteTask(editingTask!)">
          <i class="fas fa-trash me-1"></i>刪除任務
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">取消</button>
        <button type="button" class="btn btn-primary" (click)="saveEdit()">儲存</button>
      </div>
    </div>
  </div>
</div>
}