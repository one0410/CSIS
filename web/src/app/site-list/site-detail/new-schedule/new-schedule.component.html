<div class="container-fluid h-100">
  <!-- 頁面標題與工具列 -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>
          <i class="fas fa-calendar-alt me-2"></i>
          新進度表 - {{ site()?.projectName }}
          @if (flatTasks.length > 0) {
            <small class="text-muted ms-2">(共 {{ flatTasks.length }} 個工作項目)</small>
          }
        </h4>

        <div class="d-flex gap-2">
          <!-- 檢視模式切換 -->
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="viewMode" id="day" value="day" [checked]="viewMode === 'day'"
              (change)="changeViewMode('day')">
            <label class="btn btn-outline-primary btn-sm" for="day">日</label>

            <input type="radio" class="btn-check" name="viewMode" id="week" value="week" [checked]="viewMode === 'week'"
              (change)="changeViewMode('week')">
            <label class="btn btn-outline-primary btn-sm" for="week">週</label>

            <input type="radio" class="btn-check" name="viewMode" id="month" value="month"
              [checked]="viewMode === 'month'" (change)="changeViewMode('month')">
            <label class="btn btn-outline-primary btn-sm" for="month">月</label>
          </div>

          <!-- XML 匯入按鈕 -->
          <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#importXmlModal">
            <i class="fas fa-file-import me-1"></i>匯入 XML
          </button>

          <!-- 新增頂層任務按鈕 -->
          <button class="btn btn-primary btn-sm" (click)="addNewTask()">
            <i class="fas fa-plus me-1"></i>新增頂層任務
          </button>
          

        </div>
      </div>
    </div>
  </div>

  <!-- 甘特圖表格 -->
  <div class="row">
    <div class="col-12">
      <div class="card position-relative">
        <!-- 載入中覆蓋層 -->
        @if (isLoadingData) {
          <div class="loading-overlay">
            <div class="loading-content">
              <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">載入中...</span>
              </div>
              <h5 class="text-primary">載入進度表資料中...</h5>
              <p class="text-muted">請稍候，正在從資料庫載入任務資料</p>
            </div>
          </div>
        }
        
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 600px; overflow: auto;">
            <table class="table table-sm table-bordered mb-0" [style.min-width]="getTableMinWidth()">
              <!-- 表格標題 -->
              <thead class="table-light sticky-top">
                <tr>
                  <th rowspan="2"
                    style="width: 90px; min-width: 90px; position: sticky; left: 0; z-index: 10; cursor: pointer; background-color: #f8f9fa;"
                    class="table-light" title="點擊編輯任務">WBS</th>
                  <th rowspan="2"
                    style="width: 180px; min-width: 180px; position: sticky; left: 90px; z-index: 10; background-color: #f8f9fa;"
                    class="table-light" title="點擊直接編輯">內容</th>
                  <th rowspan="2"
                    style="width: 50px; min-width: 50px; position: sticky; left: 270px; z-index: 10; background-color: #f8f9fa;"
                    class="table-light" title="點擊直接編輯">天數</th>
                                     <th rowspan="2"
                     style="width: 100px; min-width: 100px; position: sticky; left: 320px; z-index: 10; background-color: #f8f9fa;"
                     class="table-light" title="子任務可編輯，父層任務自動計算">開始日 <i class="fas fa-calculator text-muted" style="font-size: 0.7rem;"></i></th>
                   <th rowspan="2"
                     style="width: 100px; min-width: 100px; position: sticky; left: 420px; z-index: 10; background-color: #f8f9fa;"
                     class="table-light" title="子任務可編輯，父層任務自動計算">結束日 <i class="fas fa-calculator text-muted" style="font-size: 0.7rem;"></i></th>
                   <th rowspan="2"
                     style="width: 50px; min-width: 50px; position: sticky; left: 520px; z-index: 10; background-color: #f8f9fa;"
                     class="table-light" title="子任務可編輯，父層任務自動計算">權重 <i class="fas fa-calculator text-muted" style="font-size: 0.7rem;"></i></th>

                  <!-- 日期欄位 - 月份標題列 -->
                  @for (monthGroup of monthGroups; track monthGroup.month + '_' + $index) {
                  <th [attr.colspan]="monthGroup.span"
                    style="width: auto; min-width: 60px; text-align: center; border-bottom: 1px solid #dee2e6;">
                    {{ monthGroup.month }}
                  </th>
                  }
                </tr>
                <tr>
                  <!-- 日期欄位 - 日期/週數/日期範圍 -->
                  @for (dateCol of dateColumns; track dateCol) {
                  <th [style.width]="getDateColumnWidth()" [style.min-width]="getDateColumnWidth()"
                    style="text-align: center; font-size: 0.75rem; border-top: none;">
                    <div>{{ getDateSubtitle(dateCol) }}</div>
                    @if (viewMode === 'week') {
                    <div style="font-size: 0.6rem; color: #6c757d; margin-top: 2px;">
                      {{ getWeekDateRange(dateCol) }}
                    </div>
                    }
                  </th>
                  }
                </tr>
              </thead>

              <!-- 表格內容 - 使用 @defer 優化大量工項渲染效能 -->
              <tbody>
                @defer (on interaction; on timer(500ms)) {
                  @for (task of flatTasks; track task.wbs + '_' + $index) {
                  <!-- 任務基本資訊列 -->
                  <tr [ngClass]="{'table-secondary': hasChildren(task), 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}">
                    <!-- WBS -->
                    <td
                      style="width: 90px; position: sticky; left: 0; z-index: 5; cursor: pointer; background-color: #f8f9fa;"
                      [ngClass]="{'table-light': true, 'table-hover': true, 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}" (click)="editTask(task)" title="點擊編輯任務">
                      <div class="d-flex align-items-center">
                        @if (hasChildren(task)) {
                        <button class="btn btn-sm btn-outline-secondary me-1 p-0"
                          style="width: 16px; height: 16px; font-size: 8px;"
                          (click)="$event.stopPropagation(); toggleTaskExpansion(task)">
                          <i [ngClass]="task.isExpanded ? 'fas fa-minus' : 'fas fa-plus'"></i>
                        </button>
                        }
                        <small [ngClass]="getIndentClass(task.level)" style="font-size: 0.7rem;">{{
                          task.wbs }}</small>
                        @if (getTaskCompletionPercentage(task) === 100) {
                        <i class="fas fa-check-circle text-success ms-1" style="font-size: 0.6rem;" title="已完成"></i>
                        }
                        <!-- 新增子任務按鈕 - 只在懸停時顯示 -->
                        <button class="btn btn-sm btn-outline-primary ms-1 p-0 add-child-btn"
                          style="width: 14px; height: 14px; font-size: 6px; opacity: 0; transition: opacity 0.2s ease;"
                          (click)="$event.stopPropagation(); addNewTask(task)" 
                          title="新增子任務">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </td>

                    <!-- 內容 -->
                    <td style="width: 180px; position: sticky; left: 90px; z-index: 5; background-color: #f8f9fa;"
                      [ngClass]="{'table-light': true, 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}">
                      <input type="text" class="form-control form-control-sm border-0 bg-transparent p-1"
                        style="font-size: 0.75rem; height: auto;" [(ngModel)]="task.name" (blur)="saveTaskFieldWithType(task, 'content')"
                        (keyup.enter)="$any($event.target).blur()" [ngClass]="getIndentClass(task.level)">
                      @if (getTaskCompletionPercentage(task) > 0) {
                      <div class="d-flex align-items-center mt-1">
                        <div class="progress flex-grow-1" style="height: 3px;">
                          <div class="progress-bar" [style.width.%]="getTaskCompletionPercentage(task)"
                            [ngClass]="getTaskCompletionPercentage(task) === 100 ? 'bg-success' : 'bg-warning'"></div>
                        </div>
                        <small class="ms-2 text-muted" style="font-size: 0.6rem; white-space: nowrap;">
                          {{ getTaskCompletionPercentage(task) }}%
                        </small>
                      </div>
                      }
                    </td>

                    <!-- 天數 -->
                    <td style="width: 50px; position: sticky; left: 270px; z-index: 5; background-color: #f8f9fa;"
                      [ngClass]="{'table-light': true, 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}">
                      <input type="number" class="form-control form-control-sm border-0 bg-transparent p-1 text-center"
                        style="font-size: 0.7rem; height: auto;" [(ngModel)]="task.days" (blur)="saveTaskFieldWithType(task, 'days')"
                        (keyup.enter)="$any($event.target).blur()" min="1" step="1">
                    </td>

                                       <!-- 開始日 -->
                     <td style="width: 100px; position: sticky; left: 320px; z-index: 5; background-color: #f8f9fa;"
                       [ngClass]="{'table-light': true, 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}">
                       @if (hasChildren(task)) {
                         <!-- 父層任務：只顯示，不可編輯 -->
                         <span class="text-muted d-block text-center" style="font-size: 0.8rem; padding: 0.375rem;">
                           {{ task.startDate }}
                         </span>
                       } @else {
                         <!-- 子任務：可編輯 -->
                         <input type="date" class="form-control form-control-sm border-0 bg-transparent p-0"
                           style="font-size: 0.8rem; height: auto;" [(ngModel)]="task.startDate" (blur)="saveTaskFieldWithType(task, 'startDate')"
                           (keyup.enter)="$any($event.target).blur()">
                       }
                     </td>

                     <!-- 結束日 -->
                     <td style="width: 100px; position: sticky; left: 420px; z-index: 5; background-color: #f8f9fa;"
                       [ngClass]="{'table-light': true, 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}">
                       @if (hasChildren(task)) {
                         <!-- 父層任務：只顯示，不可編輯 -->
                         <span class="text-muted d-block text-center" style="font-size: 0.8rem; padding: 0.375rem;">
                           {{ task.endDate }}
                         </span>
                       } @else {
                         <!-- 子任務：可編輯 -->
                         <input type="date" class="form-control form-control-sm border-0 bg-transparent p-0"
                           style="font-size: 0.8rem; height: auto;" [(ngModel)]="task.endDate" (blur)="saveTaskFieldWithType(task, 'endDate')"
                           (keyup.enter)="$any($event.target).blur()">
                       }
                     </td>

                     <!-- 權重 -->
                     <td style="width: 50px; position: sticky; left: 520px; z-index: 5; background-color: #f8f9fa;"
                       [ngClass]="{'table-light': true, 'table-success': getTaskCompletionPercentage(task) === 100, 'table-warning': getTaskCompletionPercentage(task) > 0 && getTaskCompletionPercentage(task) < 100}">
                       @if (hasChildren(task)) {
                         <!-- 父層任務：只顯示，不可編輯 -->
                         <span class="text-muted d-block text-center" style="font-size: 0.7rem; padding: 0.375rem;">
                           {{ task.weight }}%
                         </span>
                       } @else {
                         <!-- 子任務：可編輯 -->
                         <input type="number" class="form-control form-control-sm border-0 bg-transparent p-1 text-center"
                           style="font-size: 0.7rem; height: auto;" [(ngModel)]="task.weight" (blur)="saveTaskFieldWithType(task, 'weight')"
                           (keyup.enter)="$any($event.target).blur()" min="0" max="100" step="0.01">
                       }
                     </td>

                    <!-- 日期欄位 - 顯示任務時間範圍（優化版本） -->
                    @for (dateCol of dateColumns; track dateCol + '_' + $index) {
                    <td [style.width]="getDateColumnWidth()" 
                        style="text-align: center; padding: 0.1rem;"
                        [class.task-date-cell]="true"
                        [attr.data-in-range]="isDateInRange(task, dateCol)"
                        [style.background-color]="getTaskDateCellBackgroundColor(task, dateCol)">
                      <!-- 只在非日檢視模式顯示進度指示器 -->
                      @if (shouldShowDateContent(task, dateCol) && viewMode !== 'day') {
                        <span class="date-indicator" 
                              [style.font-size]="'6px'"
                              [style.opacity]="getDateIndicatorOpacity(task, dateCol)">
                          @if (viewMode === 'week' && hasProgressInWeek(task, dateCol)) {
                            ●
                          } @else if (viewMode === 'month' && hasProgressInMonth(task, dateCol)) {
                            ■
                          }
                        </span>
                      }
                    </td>
                    }
                  </tr>

                  <!-- 進度輸入列 - 只在日檢視模式下顯示 -->
                  @if (!hasChildren(task) && viewMode === 'day') {
                  <tr class="table-warning bg-opacity-10">
                    <!-- 空白欄位對齊 -->
                                       <td colspan="6"
                       style="position: sticky; left: 0; z-index: 5; width: 570px; background-color: #f8f9fa;"
                       class="table-light">
                      <small class="text-muted ps-3" style="font-size: 0.7rem;">進度輸入 (0-100%)</small>
                    </td>

                    <!-- 進度輸入欄位 - 優化版本 -->
                    @for (dateCol of dateColumns; track dateCol + '_' + $index) {
                    <td [style.width]="getDateColumnWidth()" 
                        style="text-align: center; padding: 0.1rem; position: relative;"
                        [title]="getDateInputTooltip(task, dateCol)"
                        (click)="showProgressInput($event, task, dateCol)">
                      
                      <!-- 只顯示進度值，點擊時才顯示輸入框 -->
                      @if (!isEditingProgress(task, dateCol)) {
                        <span class="progress-display"
                              [style.font-size]="'8px'"
                              [style.color]="getDisplayProgressForDate(task, dateCol) ? '#000' : '#ccc'"
                              [style.cursor]="'pointer'"
                              [ngClass]="{'bg-warning bg-opacity-25': !isDateInRange(task, dateCol), 'bg-primary bg-opacity-10': isDateInRange(task, dateCol)}">
                          {{ getDisplayProgressForDate(task, dateCol) || '-' }}
                        </span>
                      } @else {
                        <!-- 編輯時才顯示輸入框 -->
                        <input type="number" 
                               class="form-control form-control-sm text-center progress-input"
                               [style.font-size]="'8px'"
                               [style.width]="'20px'"
                               style="height: 20px;" 
                               min="0" max="100" 
                               [value]="getDisplayProgressForDate(task, dateCol)"
                               (blur)="hideProgressInput(task, dateCol, +$any($event.target).value)" 
                               (keyup.enter)="$any($event.target).blur()"
                               (keyup.escape)="cancelProgressInput(task, dateCol)"
                               placeholder=""
                               #progressInput>
                      }
                    </td>
                    }
                  </tr>
                  }
                  }

                  @if (flatTasks.length === 0) {
                  <tr>
                    <td colspan="100%" class="text-center text-muted py-4">
                      尚無任務資料，請新增任務或匯入 XML 檔案
                    </td>
                  </tr>
                  }

                } @placeholder {
                  <!-- 載入狀態 -->
                  <tr>
                    <td colspan="100%" class="text-center text-muted py-4">
                      <div class="d-flex justify-content-center align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                        載入進度表資料中...
                      </div>
                    </td>
                  </tr>
                } @loading (minimum 100ms) {
                  <!-- 最小載入時間 -->
                  <tr>
                    <td colspan="100%" class="text-center text-muted py-4">
                      <div class="d-flex justify-content-center align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                        渲染表格中...
                      </div>
                    </td>
                  </tr>
                } @error {
                  <!-- 錯誤狀態 -->
                  <tr>
                    <td colspan="100%" class="text-center text-danger py-4">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      載入進度表時發生錯誤，請重新整理頁面
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 編輯任務 Modal -->
@if (isEditing && editingTask) {
<div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">編輯任務</h5>
        <button type="button" class="btn-close" (click)="cancelEdit()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">WBS</label>
            <input type="text" class="form-control" [(ngModel)]="editingTask.wbs" name="wbs">
          </div>
          <div class="mb-3">
            <label class="form-label">任務名稱</label>
            <input type="text" class="form-control" [(ngModel)]="editingTask.name" name="name">
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">開始日期</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.startDate" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務日期由子任務自動計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="date" class="form-control" [(ngModel)]="editingTask.startDate" name="startDate">
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">結束日期</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.endDate" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務日期由子任務自動計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="date" class="form-control" [(ngModel)]="editingTask.endDate" name="endDate">
                }
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">天數</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.days" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務天數由子任務自動計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="number" class="form-control" [(ngModel)]="editingTask.days" name="days" min="1" step="1">
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">權重 (%)</label>
                @if (hasChildren(editingTask)) {
                  <!-- 父層任務：只顯示，不可編輯 -->
                  <input type="text" class="form-control" [value]="editingTask.weight" readonly
                    style="background-color: #f8f9fa; color: #6c757d;">
                  <small class="form-text text-muted">父層任務權重由子任務平均計算</small>
                } @else {
                  <!-- 子任務：可編輯 -->
                  <input type="number" class="form-control" [(ngModel)]="editingTask.weight" name="weight" min="0"
                    max="100" step="0.01">
                }
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" (click)="deleteTask(editingTask!)">
          <i class="fas fa-trash me-1"></i>刪除任務
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">取消</button>
        <button type="button" class="btn btn-primary" (click)="saveEdit()">儲存</button>
      </div>
    </div>
  </div>
</div>
}

<!-- 匯入 XML Modal -->
<div class="modal fade" id="importXmlModal" tabindex="-1" aria-labelledby="importXmlModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importXmlModalLabel">匯入 XML 進度表</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <!-- 第一階段：檔案選擇 (只在未處理且無結果時顯示) -->
          @if (!isProcessing && !importResult) {
            <div class="mb-3">
              <div class="drop-zone" 
                   (dragover)="onXmlDragOver($event)" 
                   (dragleave)="onXmlDragLeave($event)" 
                   (drop)="onXmlDrop($event)">
                請上傳 MS Project XML 檔案, 或將檔案拖放至此
              </div>
              <input type="file" class="form-control" id="xmlFileUpload" accept=".xml" title="選擇XML檔案" (change)="onXmlFileSelected($event)"/>
              <div class="mt-2 text-muted small">
                <p>
                  <strong>注意事項：</strong>
                </p>
                <ul>
                  <li>支援 Microsoft Project 匯出的 XML 格式檔案。</li>
                  <li>匯入時會以 WBS 為識別，相同 WBS 會更新現有任務。</li>
                  <li>新任務會自動建立，權重預設為 1%。</li>
                  <li>父層任務的日期和權重會自動根據子任務計算。</li>
                </ul>
              </div>
            </div>
          }
          
          <!-- 處理狀態 -->
          @if (isProcessing) {
            <div class="mt-3">
              <div class="progress mb-2">
                <div class="progress-bar" 
                     role="progressbar" 
                     [style.width.%]="processProgress" 
                     [attr.aria-valuenow]="processProgress" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                  {{processProgress}}%
                </div>
              </div>
              <p class="text-muted" style="white-space: pre-line;">{{processStatus}}</p>
            </div>
          }
          
          <!-- 結果顯示 -->
          @if (importResult) {
            <div class="mt-3">
              <div class="alert" [ngClass]="importResult.success ? 'alert-success' : 'alert-danger'">
                <h6>處理結果</h6>
                <p>{{importResult.message}}</p>
                @if (importResult.details && importResult.details.length > 0) {
                  @if (!importResult.success && importResult.formattedErrors) {
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>WBS</th>
                          <th>任務名稱</th>
                          <th>錯誤類型</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (error of importResult.formattedErrors; track error) {
                          <tr>
                            <td>{{error.wbs}}</td>
                            <td>{{error.name}}</td>
                            <td>{{error.errorType}}</td>
                          </tr>
                        }
                      </tbody>
                    </table>
                    @if (importResult.moreErrors) {
                      <p class="text-muted small">...還有 {{importResult.moreErrors}} 筆未顯示</p>
                    }
                  } @else {
                    <ul>
                      @for (detail of importResult.details; track detail) {
                        <li>{{detail}}</li>
                      }
                    </ul>
                  }
                }
              </div>
            </div>
          }
        </form>
      </div>
      <div class="modal-footer">
        <!-- 關閉按鈕：處理中時禁用，其他時候都可用 -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" [disabled]="isProcessing" (click)="closeXmlModal()">關閉</button>
        
        <!-- 第一階段：有成功解析結果且未處理且未完成時，顯示匯入按鈕 -->
        @if (importResult?.success && !isProcessing && !isCompleted) {
          <button type="button" class="btn btn-primary" (click)="executeXmlImport()">
            匯入並套用
          </button>
        }
        
        <!-- 第二階段：處理中時，顯示處理中按鈕 -->
        @if (isProcessing) {
          <button type="button" class="btn btn-primary" disabled>
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            處理中...
          </button>
        }
        
        <!-- 第三階段：處理完成後，只顯示關閉按鈕（上面已有） -->
      </div>
    </div>
  </div>
</div>