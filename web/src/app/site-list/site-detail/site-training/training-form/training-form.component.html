<div class="container-fluid bg-light min-vh-100 p-3 training-form">
  <div class="card form-card shadow-sm">
    <div class="card-body p-4">
      <!-- 實際表單內容容器 -->
      <div class="print-content">
        <!-- 頁面標題 -->
        

        <!-- 教育訓練表單 -->
        <div class="card shadow-sm training-form-card">
          <!-- 共用表頭（與其他表單一致） -->
          <app-site-form-header title="教育訓練簽到表"></app-site-form-header>

          <div class="card-body">
            <!-- 基本資訊（紙本樣式排列） -->
            <table class="table mb-3">
              <tbody>
                <tr>
                  <td class="bg-light" style="width: 15%">訓練課程：</td>
                  <td style="width: 35%">
                    <input type="text" class="form-control" [(ngModel)]="formData.courseName" [readonly]="isViewMode && !isWorkerSigningMode" aria-label="訓練課程" required />
                  </td>
                  <td class="bg-light" style="width: 15%">日　　期：</td>
                  <td style="width: 35%">
                    <input type="date" class="form-control" [(ngModel)]="formData.trainingDate" [readonly]="isViewMode && !isWorkerSigningMode" aria-label="日期" required />
                  </td>
                </tr>
                <tr>
                  <td class="bg-light">講　　師：</td>
                  <td>
                    <input type="text" class="form-control" [(ngModel)]="formData.instructor" [readonly]="isViewMode && !isWorkerSigningMode" aria-label="講師" />
                  </td>
                  <td class="bg-light">時　　間：</td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <input type="time" class="form-control" style="max-width: 160px" [(ngModel)]="formData.trainingTime" (ngModelChange)="onTimeChange()" [readonly]="isViewMode && !isWorkerSigningMode" aria-label="時間起" required />
                      <span class="mx-1">～</span>
                      <input type="time" class="form-control" style="max-width: 160px" [(ngModel)]="formData.trainingTimeEnd" (ngModelChange)="onTimeChange()" [readonly]="isViewMode && !isWorkerSigningMode" aria-label="時間迄" />
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="ms-2">共</span>
                      <input type="text" class="form-control" style="max-width: 80px" [value]="trainingHours" [readonly]="true" aria-label="共小時" />
                      <span>小時</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- 參與者簽到表 -->
            <div class="mt-4">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h5>參與者簽到</h5>
                @if (isLoggedIn && !isWorkerSigningMode) {
                <button
                  type="button"
                  (click)="showWorkerVerificationModal()"
                  class="btn btn-secondary btn-sm"
                  aria-label="新增簽名"
                >
                  <i class="fas fa-plus-circle me-1"></i>新增簽名
                </button>
                }
              </div>

              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead class="table-light">
                    <tr class="text-center">
                      <th style="width: 6%">NO</th>
                      <th style="width: 22%">單位</th>
                      <th style="width: 14%">工號</th>
                      <th style="width: 18%">姓名</th>
                      <th style="width: 24%">簽到</th>
                      <th style="width: 16%">備註</th>
                    </tr>
                  </thead>
                  <tbody>
                      @for (rowIndex of [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]; track rowIndex) {
                      <tr>
                        <td class="text-center">{{ rowIndex + 1 }}</td>
                        <td>
                          <input
                            type="text"
                            class="form-control form-control-sm border-0"
                            [ngModel]="getSignatureField(rowIndex, 'company')"
                            (ngModelChange)="setSignatureField(rowIndex, 'company', $event)"
                            [readonly]="isViewMode && !isWorkerSigningMode"
                            aria-label="單位"
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            class="form-control form-control-sm border-0"
                            [ngModel]="getSignatureField(rowIndex, 'employeeNo')"
                            (ngModelChange)="setSignatureField(rowIndex, 'employeeNo', $event)"
                            [readonly]="isViewMode && !isWorkerSigningMode"
                            aria-label="工號"
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            class="form-control form-control-sm border-0"
                            [ngModel]="getSignatureField(rowIndex, 'name')"
                            (ngModelChange)="setSignatureField(rowIndex, 'name', $event)"
                            [readonly]="isViewMode && !isWorkerSigningMode"
                            aria-label="姓名"
                          />
                        </td>
                        <td class="text-center">
                          @if (getSignatureField(rowIndex, 'signature')) {
                          <img
                            [src]="getSignatureField(rowIndex, 'signature')"
                            style="max-width: 120px; max-height: 50px"
                            class="img-fluid"
                            alt="簽名"
                          />
                          }
                        </td>
                        <td>
                          <input type="text" class="form-control form-control-sm border-0" [ngModel]="getSignatureField(rowIndex, 'remarks')" (ngModelChange)="setSignatureField(rowIndex, 'remarks', $event)" [readonly]="isViewMode && !isWorkerSigningMode" aria-label="備註" />
                        </td>
                      </tr>
                      }
                    </tbody>
                </table>
              </div>
            </div>

            <!-- 備註 -->
            <div class="mt-3">
              <label class="form-label">備註:</label>
              <textarea
                class="form-control"
                rows="3"
                [(ngModel)]="formData.remarks"
                [readonly]="isViewMode && !isWorkerSigningMode"
                placeholder="請輸入備註內容..."
                aria-label="備註"
              ></textarea>
            </div>
            <div class="text-end mb-3">
              <small class="text-muted">QP-6201-07C</small>
            </div>
          </div>
        </div>

        <!-- 底部按鈕區域 - 只在登入狀態或非工人簽名模式下顯示 -->
        @if (isLoggedIn && !isWorkerSigningMode) {
        <div class="d-flex justify-content-between mt-4 pt-3">
          <button
            type="button"
            class="btn btn-outline-secondary px-4"
            (click)="cancel()"
          >
            <i class="fas fa-times-circle me-1"></i>取消
          </button>
          @if (formId) {
          <div class="mx-auto d-flex gap-2">
            <button
              type="button"
              class="btn btn-info px-4"
              (click)="showQrCodeModal()"
            >
              <i class="fas fa-qr-code me-1"></i>顯示 QR Code
            </button>
            <button
              type="button"
              class="btn btn-success px-4"
              (click)="generateDocx()"
            >
              <i class="fas fa-file-word me-1"></i>下載 Word
            </button>
          </div>
          }
          <div class="ms-auto">
            <button
              type="button"
              class="btn btn-primary px-4"
              (click)="saveForm()"
            >
              <i class="fas fa-save me-1"></i>儲存
            </button>
          </div>
        </div>
        }

        <!-- 工人簽名專用按鈕 -->
        @if (isWorkerSigningMode) {
        <div class="text-center mt-4 pt-3">
          <button
            type="button"
            (click)="showWorkerVerificationModal()"
            class="btn btn-primary btn-lg px-4 py-3"
            aria-label="我要簽名"
          >
            <i class="fas fa-pen me-2"></i>我要簽名
          </button>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- 工人身份驗證 Modal -->
  <div
    class="modal fade"
    id="workerVerificationModal"
    tabindex="-1"
    aria-labelledby="workerVerificationModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="workerVerificationModalLabel">
            員工或人才身份驗證
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="關閉"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="verificationId" class="form-label"
              >請輸入員工工號或人才身份證號碼、手機號碼</label
            >
            <input
              type="text"
              class="form-control"
              id="verificationId"
              [(ngModel)]="verificationIdOrPhone"
              placeholder="工號、身份證號碼或手機號碼"
            />
          </div>
          @if (verificationError) {
          <div class="alert alert-danger">{{ verificationError }}</div>
          }
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            取消
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="verifyWorker()"
          >
            驗證
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div
    class="modal fade"
    id="qrCodeModal"
    tabindex="-1"
    aria-labelledby="qrCodeModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrCodeModalLabel">
            <i class="fas fa-qr-code me-2"></i>
            教育訓練表單 QR Code
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="關閉"
          ></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-3">
            <h6 class="text-muted">請工作人員掃描以下QR Code進行教育訓練簽名</h6>
          </div>
          
          <!-- QR Code 顯示區域 -->
          @if (formQrCodeUrl) {
          <div class="d-flex justify-content-center mb-4">
            <div class="border rounded p-3 bg-light">
              <qrcode
                [qrdata]="formQrCodeUrl"
                [width]="256"
                [errorCorrectionLevel]="'M'"
                [elementType]="'canvas'"
                [margin]="4"
              ></qrcode>
            </div>
          </div>
          } @else {
          <div class="text-center">
            <p class="text-muted">QR Code 載入中...</p>
          </div>
          }
          
          <!-- 網址顯示 -->
          @if (formQrCodeUrl) {
          <div class="mb-3">
            <label class="form-label text-muted">教育訓練表單網址:</label>
            <div class="input-group">
              <input 
                type="text" 
                class="form-control text-center" 
                [value]="formQrCodeUrl" 
                readonly
                #urlInput
              >
              <button 
                class="btn btn-outline-secondary" 
                type="button"
                (click)="copyUrl(urlInput)"
              >
                <i class="fas fa-copy"></i>
                複製
              </button>
            </div>
          </div>
          }
          
          <!-- 說明文字 -->
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            工作人員掃描QR Code後，將進入教育訓練表單頁面，完成簽名後資料會自動記錄在表單中。
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            關閉
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
