# CSIS 部署方案說明

本專案提供兩種部署方案，適應不同的部署環境和需求：

## 方案一：Docker 映像檔部署 (離線部署)

### 適用場景
- 生產環境沒有網路連接或網路受限
- 需要完全離線部署
- 伺服器沒有安裝開發工具 (Git, Node.js, 編譯器等)
- 需要嚴格的版本控制和一致性

### 檔案與工具
- `export.bat` / `export.sh` - 建構和打包映像檔
- `import.bat` / `import.sh` - 在目標伺服器上匯入和部署

### 使用流程

#### 1. 在開發機上建構部署包
```bash
# Windows
export.bat

# Linux/macOS
./export.sh
```

#### 2. 傳輸部署包
將生成的 `deployment/csis-deployment-YYYYMMDD_HHMMSS.zip` (約 1.7GB) 複製到目標伺服器

#### 3. 在目標伺服器上部署
```bash
# 解壓縮部署包
unzip csis-deployment-YYYYMMDD_HHMMSS.zip
cd csis-deployment-YYYYMMDD_HHMMSS

# 執行部署腳本
# Windows
scripts\import.bat

# Linux
./scripts/import.sh
```

### 優點
- ✅ 完全離線部署
- ✅ 不需要在目標伺服器安裝開發工具
- ✅ 部署過程簡單可靠
- ✅ 版本一致性高

### 缺點
- ❌ 部署包檔案大 (1.7GB)
- ❌ 傳輸時間長
- ❌ 每次更新都需要完整傳輸

---

## 方案二：Git 自動部署 (線上部署)

### 適用場景
- 伺服器有穩定的網路連接
- 可以在伺服器上安裝開發工具
- 需要快速部署小的程式碼變更
- 開發或測試環境

### 檔案與工具
- `deploy-from-git.bat` / `deploy-from-git.sh` - Git 自動部署腳本

### 使用流程

#### 1. 在開發機上提交代碼
```bash
git add .
git commit -m "更新功能"
git push origin main
```

#### 2. 在目標伺服器上部署
```bash
# Windows
deploy-from-git.bat [分支名稱]

# Linux
./deploy-from-git.sh [分支名稱]

# 範例 (部署 main 分支)
./deploy-from-git.sh main
```

### 腳本功能特點
- 🔍 **環境檢查**: 自動檢查 Git、Docker 等必要工具
- 📦 **自動備份**: 部署前自動備份當前狀態
- 🔄 **代碼更新**: 從 GitHub 拉取最新代碼
- 🐳 **重新建構**: 重新建構 Docker 映像檔
- 🩺 **健康檢查**: 部署後自動檢查服務狀態
- 🔙 **智能回滾**: 部署失敗時可選擇自動回滾
- 📝 **詳細日誌**: 記錄完整的部署過程

### 優點
- ✅ 傳輸量小 (只傳輸代碼變更)
- ✅ 部署速度快
- ✅ 支援自動回滾
- ✅ 詳細的日誌記錄
- ✅ 適合頻繁更新

### 缺點
- ❌ 需要網路連接
- ❌ 需要在伺服器安裝開發工具
- ❌ 首次建構時間較長

---

## 部署方案選擇建議

| 環境類型 | 建議方案 | 原因 |
|---------|---------|------|
| **生產環境** | 方案一 (映像檔) | 穩定、可靠、版本控制嚴格 |
| **測試環境** | 方案二 (Git) | 快速、適合頻繁更新 |
| **開發環境** | 方案二 (Git) | 即時更新、方便除錯 |
| **離線環境** | 方案一 (映像檔) | 唯一選擇 |
| **網路受限** | 方案一 (映像檔) | 避免網路相關問題 |

---

## 前置要求

### 方案一 (映像檔部署)
**開發機要求:**
- Docker
- Docker Compose

**目標伺服器要求:**
- Docker
- Docker Compose

### 方案二 (Git 自動部署)
**開發機要求:**
- Git
- 可以 push 到 GitHub

**目標伺服器要求:**
- Git
- Docker
- Docker Compose
- 網路連接 (可以存取 GitHub)

---

## 故障排除

### 常見問題

#### 1. Git 部署失敗
```bash
# 檢查網路連接
ping github.com

# 檢查 Git 配置
git config --list

# 手動拉取測試
git fetch origin
```

#### 2. Docker 建構失敗
```bash
# 清理 Docker 快取
docker system prune -a

# 檢查磁碟空間
df -h
```

#### 3. 服務啟動失敗
```bash
# 檢查服務日誌
docker compose logs

# 檢查特定服務
docker compose logs [服務名稱]
```

### 回滾操作

**方案一**: 使用之前的部署包重新部署
**方案二**: 腳本會自動提供回滾選項，或手動使用備份目錄

---

## 安全注意事項

1. **定期備份**: 兩種方案都會創建備份，但請定期進行完整的系統備份
2. **權限控制**: 確保部署腳本只有授權人員可以執行
3. **SSL 憑證**: 部署前確保 SSL 憑證已正確配置
4. **環境變數**: 檢查 `.env` 檔案中的敏感資訊
5. **防火牆設定**: 確保必要的連接埠已開放

---

## 聯絡支援

如果在部署過程中遇到問題，請：

1. 檢查部署日誌檔案
2. 確認前置要求是否滿足
3. 參考故障排除章節
4. 如需協助，請提供完整的錯誤訊息和日誌檔案 