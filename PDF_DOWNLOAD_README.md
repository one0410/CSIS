# PDF下載功能使用說明

## 功能概述

在工地日報表的「各廠商當日執行內容」區塊中，新增了PDF下載功能，支援：
1. **單個表單下載** - 一鍵下載單個表單的PDF
2. **批量下載** - 將當日所有表單打包成ZIP檔案下載

## 使用方式

### 單個表單下載
- 在每個表單項目的右側，點擊PDF圖示按鈕
- 系統將自動生成該表單的PDF並下載
- 檔案名稱格式：`表單類型_廠商名稱_日期_表單ID.pdf`

### 批量下載
- 點擊標題列的「下載全部」按鈕
- 系統將生成所有當日表單的PDF，並打包成ZIP檔案
- ZIP檔案名稱格式：`工地名稱_日期_表單集合.zip`
- 下載過程中會顯示進度條，顯示目前處理的表單名稱

## 技術實作

### 核心技術棧
- **html2canvas** - 將HTML內容轉換為圖片
- **jsPDF** - 生成PDF文件
- **JSZip** - 打包多個檔案為ZIP

### 實作方式
1. **隱藏iframe載入** - 在背景載入表單頁面，避免干擾用戶
2. **內容擷取** - 尋找表單中的`.print-content`區域進行擷取
3. **PDF生成** - 將擷取的內容轉換為高品質PDF（2x縮放）
4. **多頁支援** - 自動處理超過A4大小的長表單，分頁顯示
5. **錯誤處理** - 對失敗的表單生成錯誤報告並包含在ZIP中

### 檔案結構
```
src/app/
├── services/
│   └── pdf-download.service.ts          # PDF下載核心服務
└── site-list/site-detail/site-daily-report/daily-work-content/
    └── daily-work-content.component.ts  # 日報表組件（含下載UI）
```

## 支援的表單類型

所有表單組件都已配置適當的`.print-content`區域：

- ✅ 工地許可單 (`sitePermit`)
- ✅ 工具箱會議 (`toolboxMeeting`)
- ✅ 環安衛自檢表 (`environmentChecklist`)
- ✅ 特殊作業自檢表 (`specialWorkChecklist`)
- ✅ 工安巡迴檢查表 (`safetyPatrolChecklist`)
- ✅ 工安缺失紀錄單 (`safetyIssueRecord`)
- ✅ 危害告知單 (`hazardNotice`)
- ✅ 教育訓練 (`training`)

## 使用者介面特色

### 下載按鈕設計
- **單個下載**：PDF圖示，點擊後不影響表單導航
- **批量下載**：主要按鈕，含載入動畫和禁用狀態
- **進度顯示**：批量下載時顯示進度條和當前處理項目

### 錯誤處理
- 網路連線問題：30秒超時機制
- 表單載入失敗：跳過該表單，繼續處理其他表單
- 部分失敗：在ZIP中包含錯誤報告文件

### 用戶體驗優化
- 下載期間按鈕顯示載入狀態
- 批量下載顯示詳細進度資訊
- 失敗表單不會中斷整個流程
- 自動生成有意義的檔案名稱

## 設定要求

### 必要依賴套件
```json
{
  "html2canvas": "^1.4.1",
  "jspdf": "^3.0.1", 
  "jszip": "^3.10.1"
}
```

### 瀏覽器兼容性
- Chrome 70+
- Firefox 70+
- Edge 79+
- Safari 14+

## 限制與注意事項

1. **表單必須可存取** - 表單頁面必須對當前用戶開放存取權限
2. **網路連線** - 需要穩定的網路連線以載入表單內容
3. **瀏覽器限制** - 部分瀏覽器可能限制自動下載多個檔案
4. **檔案大小** - 複雜表單可能產生較大的PDF檔案
5. **跨域限制** - 表單內容如有外部資源可能影響PDF品質

## 故障排除

### 下載失敗
1. 檢查網路連線狀態
2. 確認表單頁面可正常存取
3. 檢查瀏覽器是否允許檔案下載
4. 查看瀏覽器開發者工具的錯誤訊息

### PDF品質問題
1. 確認表單具有`.print-content`類別
2. 檢查表單樣式是否適合列印
3. 考慮調整html2canvas的scale參數

### 批量下載不完整
1. 檢查ZIP檔案中的錯誤報告
2. 個別測試失敗的表單
3. 確認所有表單類型的路由配置正確

## 未來擴充計畫

1. **PDF設定選項** - 允許用戶選擇PDF格式和品質
2. **範本自訂** - 支援自訂PDF頁首頁尾
3. **大量下載** - 支援跨日期範圍的批量下載
4. **雲端同步** - 整合雲端儲存服務
5. **簽名整合** - PDF中顯示數位簽名狀態

## 開發維護

### 新增表單類型支援
1. 在表單HTML中添加`.print-content`包裝
2. 在`pdf-download.service.ts`中添加路由配置
3. 在`getFormFileName()`中添加顯示名稱對應

### 效能調優
- 調整iframe載入等待時間
- 優化html2canvas參數
- 考慮使用Web Workers處理大型檔案

---

**版本**: v1.0.0  
**最後更新**: 2024年1月  
**開發者**: CSIS 開發團隊 